# プロセス・ジョブ管理

## プロセス管理

### ps

- `ps`コマンドは、現在動作しているプロセスを表示する。

  ```bash
  ps
  ```

- 表示系オプション
  - `a`オプションで、全てのユーザーのプロセスを表示する。
  - `x`オプションで、実行端末のないプロセスを表示する。
  - `-e`オプションで、全てのプロセスを表示する。（axオプションと同じ）
- 表示形式系オプション
  - `u`オプションで、実行ユーザー名などを表示する。
  - `l, -l`オプションで、親プロセスのPID（PPID）やナイス値も表示する。
  - `f`オプションで、階層構造を分かりやすく表示する。
- プロセスは、PID、及びプロセスを開始したユーザーから引き継がれたUIDとGIDを持つ。

### pstree

- `pstree`コマンドは、現在動作しているプロセスについて、階層構造を分かりやすく表示する。（`ps f`コマンドと同じ）

  ```bash
  pstree [プロセスIDまたはユーザー名]
  ```

- Macではインストールが必要。

### top

- `top`コマンドは、現在実行中のプロセスを継続的に表示する。

  ```bash
  top
  ```

### pgrep

- `pgrep`コマンドは、指定したプロセス名に対応するPIDを表示する。

    ```bash
    pgrep プロセス名
    ```

### lsof

- `lsof`コマンドは、**現在開いているファイル一覧**を表示する。

  ```bash
  lsof [パス名]
  ```

- `-i :ポート番号`オプションで、**ポート番号やプロトコル**を指定できる。

- `-p プロセスID`オプションで、プロセスIDを指定できる。

- `-P`オプションで、ポート番号が数字で表示されるようになる。

- 例（接続を受け付けているポートに絞り込む場合）

  ```bash
  lsof -p プロセスID | grep LISTEN
  ```

## シグナル処理

### シグナル

| シグナルID | シグナル名 | 意味                                 |
| ---------- | ---------- | ------------------------------------ |
| 1          | HUP        | ハングアップ                         |
| 2          | INT        | 割り込みによる終了（Ctrl + Cと同じ） |
| 9          | KILL       | 強制終了                             |
| 15         | TERM       | 終了                                 |

### kill, killall, pkill

- `kill`コマンドは、指定した**プロセスID**のプロセスを終了させる。（シグナルを送る）

  ```bash
  kill プロセスID
  ```

- `killall, pkill`コマンドは、指定した**プロセス名（コマンド）**のプロセスを終了させる。

  ```bash
  killall プロセス名
  ```

- `-l`オプションで、シグナル一覧を確認できる。

- `-シグナル`または`-s シグナル`オプションで、シグナルを指定できる。
  - シグナルは、シグナル名またはシグナルIDで指定する。
  - シグナル名は、先頭に`SIG`を付けてもよい。
  - デフォルトは`TERM`シグナルとなる。

- 一般ユーザーは、自身が実行したプロセスのみ終了できる。

### trap

- `trap`コマンドは、送られたシグナルを捕捉して処理を行う。

- 書式

  ```bash
  trap 処理 シグナル名...
  ```

- 例

  ```bash
  trap 'echo message!!' INT
  ```

## ジョブ管理

### &

- コマンドをバックグラウンドで実行する場合。

  ```bash
  コマンド &
  ```

- バックグラウンドでコマンド1を実行しつつ、コマンド2も実行する場合

  ```bash
  コマンド1 & コマンド2
  ```

### nohup

- `nohup`コマンドは、仮想端末を閉じたりログアウトしたりしても、コマンドをバックグラウンド実行させる。

  ```bash
  nohup コマンド &
  ```

### jobs

- `jobs`コマンドは、現在ユーザが設定した**ジョブ一覧**を表示する。

  ```bash
  jobs [ジョブ番号]
  ```

- 表示内容
  - `+`は、現在実行中のプロセスを表す。
  - `-`は、直前に実行されたプロセスを表す。

### fg, bg

- `fg`コマンドは、バックグランドジョブを、フォアグランドジョブに切り替える。

  ```bash
  fg ジョブ番号
  ```

- `bg`コマンドは、一時停止しているジョブを、バックグランドジョブとして再開する。

  ```bash
  bg ジョブ番号
  ```

## ジョブスケジューリング

### crontab

- `crontab`コマンドは、定期的に実行するジョブを管理する。（crontabファイルを管理する）

  ```bash
  crontab
  ```

- `-l`オプションで、crontabファイルを表示する。

- `-e`オプションで、crontabファイルを編集する。

- `-r`オプションで、crontabファイルを削除する。

- `-u ユーザー名`オプションで、編集するユーザーを指定できる。（rootユーザーのみ）

### crontabファイル

- `/etc/crontab`ファイルは、システム用のcrontabファイルであり、以下のファイルを呼び出す。

  - `/etc/cron.d/`
  - `/etc/cron.hourly/`
  - `/etc/cron.daily/`
  - `/etc/cron.weekly/`
  - `/etc/cron.monthly/`

- `/var/spool/cron`ディレクトリ以下に、ユーザーのcrontabファイルが格納される。

- 書式

  ```text
  分 時 日 月 曜日 コマンド
  ```

- スケジュールの指定

  - `*`で、すべての値にマッチする。
  - カンマ区切りで、複数の値を指定できる。
  - `*/数値`で、数値の間隔で実行させる。（例：分を`*/10`とすると、10分間隔となる）

- 例

  ```text
  00,30 */2 * * * /usr/local/bin/backup
  ```

### at

- `at`コマンドは、1回限りで実行するジョブを対話的に管理する。

  ```bash
  at 日時
  ```

- 日時形式例
  - `22:00`
  - `10pm`
  - `noon`
  - `now + 3 days`
- オプション
  - `-f ファイル名`オプションで、実行するコマンドを記述したファイルを読み込む。
  - `-l`オプションで、予約中のジョブの一覧を表示する。（`atq`コマンドと同じ）
  - `-d|-r ジョブ番号`オプションで、予約中のジョブを削除する。（`atrm`コマンドと同じ）
- [Macでatコマンドが実行できないときの対処法 - Qiita](https://qiita.com/shge/items/6c43947a77abd9d2d1b2)

### アクセス制御

- `/etc/cron.allow`, `/etc/cron.deny`ファイルには、cronの利用を許可・拒否するユーザーを記述する。
- `/etc/at.allow`, `/etc/at.deny`ファイルには、atの利用を許可・拒否するユーザーを記述する。
- `allow`ファイル、`deny`ファイルの順で、どちらかのファイルのみが適用される。

### systemdによるスケジューリング

- systemdのタイマーUnitを使うことでも、スケジューリングを設定できる。
- `systemd-run`コマンドで、スケジュールを予約できる。

## システム状況管理

### free

- `free`コマンドは、メモリの利用状況、空き状況を表示する。

  ```bash
  free
  ```

- `-m`オプションで、MB単位で表示する。
- Macでは使用不可。

### uptime

- `uptime`コマンドは、システムの稼働時間や平均負荷を表示する。

  ```bash
  uptime
  ```

### watch

- `watch`コマンドは、コマンドを一定時間ごとに実行する。

  ```bash
  watch コマンド
  ```

- Macでは使用不可。

## 優先度管理

### ナイス値

- ナイス値は`-20`から`19`まであり、その値が大きいほどプロセスの優先度が低くなる。
  （他のプロセスに対してナイスである）

### nice

- `nice`コマンドは、ナイス値を指定してコマンドを実行する。

  ```bash
  nice コマンド
  ```

- `-n ナイス値`または`-ナイス値`オプションで、ナイス値を指定できる。
  （指定しなかった場合は`+10`となる）
- rootユーザーのみ、ナイス値に負数を指定できる。

### renice

- `renice`コマンドは、実行中プロセスのナイス値を変更する。

  ```bash
  renice [-n] ナイス値 [-p] プロセスID
  ```
