# AWS/ネットワーキングとコンテンツ配信/Amazon VPC

## 共通

### 概要

- **Amazon Virtual Private Cloud（Amazon VPC）**とは、AWS上の特定のリージョンに、独立したネットワーク空間を作成できるサービスである。

- [Amazon VPC とは? - Amazon Virtual Private Cloud](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/what-is-amazon-vpc.html)

### サブネット

- **サブネット**は、VPCのIPアドレスの範囲である。

| サブネットタイプ       | 概要                                             |
| ---------------------- | ------------------------------------------------ |
| パブリックサブネット   | インターネットゲートウェイへの直接ルートがある。 |
| プライベートサブネット | インターネットゲートウェイへの直接ルートがない。 |

### VPCに接続する

- **インターネットゲートウェイ（IGW）**は、VPCとインターネットとの間の通信を可能にする VPC コンポーネントである。
- **Egress-Onlyインターネットゲートウェイ**は、IPv6経由でのVPCからインターネットへのアウトバウンド送信を可能にする。
- **NATゲートウェイ**または**NATインスタンス**を使用すると、プライベートサブネット内のインスタンスは VPC 外のサービスに接続できる。
  （IPv4はサポートしていない）
- NATゲートウェイは、NATインスタンスより**高い可用性**が期待できる。

### VPCピアリング

- **VPCピアリング**は、異なるVPC間をプライベート接続するサービスである。
- VPCピアリングでは、**推移的なピアリング**はサポートしていない。
- **フルメッシュ**は、参加する各通信主体（ノード）が自分以外のすべてのノードと接続する形態である。

### VPCエンドポイント

- **VPCエンドポイント**は、VPCと他サービス間でプライベートな接続を提供するコンポーネントであり、下記の種類がある。

    | 種類                           | 概要                                                         | 対応サービス | 料金                                                   |
    | ------------------------------ | ------------------------------------------------------------ | ------------ | ------------------------------------------------------ |
    | ゲートウェイエンドポイント     | ルートテーブルに指定されたターゲットを追加する。             | S3、DynamoDB | 無料                                                   |
    | インターフェイスエンドポイント | ENIとDNSが作成される。<br />**AWS PrivateLink**という技術で、<br />ENIとサービス間をプライベートに接続できる。<br />[AWS PrivateLink の概要 - Amazon Virtual Private Cloud](https://docs.aws.amazon.com/ja_jp/vpc/latest/privatelink/what-is-privatelink.html) | 50以上       | 時間単位の使用料金と<br />データ処理料金が課金される。 |

### ENI

- **Elastic Network Interface（ENI）**は、VPC上で実装する仮想ネットワークインターフェースである。
- ENIは、物理環境におけるNIC（Network Interface Card）に相当する。
- 仮想サーバーにアタッチすることで、サーバーがIPアドレスを持ち、ネットワーク接続することができる。

### AWS Transit Gateway

- **AWS Transit Gateway**は、VPC内にハブの機能を備えたゲートウェイを配置するサービスである。
- **Transit Gateway Network Manager**は、プライベートネットワークを地図上にマッピングして可視化する。

### セキュリティ

- **セキュリティグループ**、**ネットワークアクセスコントロールリスト（ACL）**は、
  特定のインバウンドまたはアウトバウンドのトラフィックを、許可または拒否する。
- 実際のセキュリティグループの適用では、インバウンド通信は最低限必要な通信のみ許可し、アウトバウンド通信は全て許可しておくのが一般的である。
- セキュリティグループとネットワークACLの両方でルールが適用されている場合、**両方で許可されないと拒否になる。**

| 種類                 | デフォルト動作                                           | 適用範囲         | 評価順                   | ステータス                                                   |
| -------------------- | -------------------------------------------------------- | ---------------- | ------------------------ | ------------------------------------------------------------ |
| セキュリティグループ | インバウンド：全て**拒否**<br />アウトバウンド：全て許可 | インスタンス単位 | 全てのルールが適用される | ステートフル<br />（アウトバウンドの通信も自動で許可される） |
| ネットワークACL      | インバウンド：全て許可<br />アウトバウンド：全て許可     | サブネット単位   | ルール番号順に適用される | ステートレス<br />（インバウンド・アウトバウンドの両方の許可が必要） |

### VPCフローログ

- **VPCフローログ**は、VPC のネットワークインターフェイスとの間で行き来するトラフィック情報をキャプチャするサービスである。

- VPCフローログには、送信元IPアドレス、送信元ポート、送信先IPアドレス、送信先ポート、プロトコルなどが含まれる。
  （トラフィックの中身までは確認できない）

- 例（アカウント`123456789010`のネットワークインターフェイス`eni-1235b8ca123456789`へのSSH トラフィック（送信先ポート 22、TCP プロトコル）が許可されている）

  ```text
  2 123456789010 eni-1235b8ca123456789 172.31.16.139 172.31.16.21 20641 22 6 20 4249 1418530010 1418530070 ACCEPT OK
  ```

### トラフィックミラーリング

- **トラフィックミラーリング**では、パケットフローのコピーを作成して、パケットの内容を調べることができる。
- **MTU（Maximum Transmission Unit）**とは、通信機器などが一度に送信できる最大のデータ量のこと。
- ミラーソースからのトラフィックパケットサイズが、トラフィックミラーターゲットのMTUサイズより大きい場合、パケット切り詰めが発生する。

### その他

- EC2やRDS作成時には、VPCを選択する必要がある。
- VPCには物理的なルーターがなく、ソフトウェアがルーティングを行う。
- デフォルトVPCは「/16」、デフォルトのサブネットは「/20」である。
