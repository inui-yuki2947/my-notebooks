# テキスト/JSON,YAML/jq

## インストール

### Mac

```bash
brew install jq
```

## jq

### コマンド

| コマンド                               | 概要                                                         |
| -------------------------------------- | ------------------------------------------------------------ |
| `jq jq表現`                            | 標準入力について、jq表現を適用する。                         |
| `jq jq表現 ファイル名1 ファイル名2...` | 指定した（全ての）ファイルの内容について、jq表現を適用する。 |

- 入力となるJSONの文字列としては、通常のJSON文字列のほか、
  連続したJSON文字列（例：`{"name":"Yamada"}{"name":"Suzuki"}`）を渡すことも可能。

### オプション

| 分類         | オプション             | 概要                                                         |
| ------------ | ---------------------- | ------------------------------------------------------------ |
| 入力         | `-s, --slurp`          | 連続したJSON文字列（例：`{"name":"Yamada"}{"name":"Suzuki"}`）を<br />1つの配列に変換してから、jq表現を適用する。 |
| 入力         | `-R, --raw-input`      | 各行を文字列として解釈する。<br />`-s`オプションと組み合わせると、全ての入力を単一の長い文字列として解釈する。 |
| 入力         | `-n, --null-input`     | 入力を読み込まず、引数で指定した文字列をJSONとして扱う。     |
| 出力         | `-r`                   | 出力時、両端のダブルクォーテーションを除去する。             |
| 出力         | `-c, --compact-output` | 出力時、各要素を1行で出力する。                              |
| 出力         | `--tab`                | 出力時、インデントとして、タブ文字を使用する。（デフォルトはスペース） |
| 出力         | `--indent 数字`        | 出力時、インデント幅を指定した幅にする。（デフォルトは2）    |
| キーアサイン | `--arg キー バリュー`  | `$キー`に`バリュー`を割り当てる。                            |
| その他       | `-e, --exit-status`    | 結果が`false`または`null`の場合に、終了ステータス`1`を返す。 |

## jq表現

### 書式

| 分類       | 書式                                                         | 概要                                                         |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 基本       | `.`                                                          | ルートの値を出力する。                                       |
| 基本       | `オブジェクト.プロパティ名` ※1<br />`オブジェクト.["プロパティ名"]` ※1 | オブジェクトのプロパティの値を出力する。<br />（見つからない場合は`null`） |
| 基本       | `配列.[インデックス]`                                        | 配列のインデックス（0始まり）の要素を出力する。<br />（見つからない場合は`null`） |
| 基本       | `配列またはオブジェクト[]` ※1                                | 配列の全ての要素、またはオブジェクトの全ての値について、別の行で出力する。 |
| 基本       | `配列またはオブジェクト[]jq表現` ※1                          | 配列の全ての要素、またはオブジェクトの全ての値について、jq表現を実行する。 |
| 基本       | `jq表現1, jq表現2`                                           | それぞれのjq表現を、別の行で出力する。                       |
| 基本       | `jq表現1 ｜ jq表現2`                                         | jq表現1の出力の各行について、jq表現2を実行する。             |
| 型と値     | `[jq表現, jq表現, ...]`                                      | 配列形式で出力する。                                         |
| 型と値     | `{キー: jq表現, キー: jq表現, ...}`                          | オブジェクト形式で出力する。                                 |
| 条件と比較 | `a // b`                                                     | `a`が`null`または`false`である場合に、`b`を出力する。        |
| 代入       | `jq表現 ｜= 値`                                              | 指定したjq表現に値を代入し、全ての値を返す。※2<br />（右辺での`.`は、**左辺**と同じ） |
| 代入       | `jq表現 = 値`                                                | 指定したjq表現に値を代入し、全ての値を返す。※2<br />（右辺での`.`は、**入力全体**と同じ） |
| その他     | `jq表現 as $変数名`                                          | jq表現の値を変数に代入する。                                 |

- jq表現は、JSONで使える表現に加え、上記の特有の表現が使用可能である。
- ※1 末尾に`?`をつけると、プロパティやインデックスが見つからない場合に、エラーを出さないようにできる。
- ※2 代入された値は、ディープコピーされたような挙動となる。

## 組み込み演算子・関数

### 書式

| 書式               | コマンド例        | 入力例                                             | 出力例                                             | 概要                                                         |
| ------------------ | ----------------- | -------------------------------------------------- | -------------------------------------------------- | ------------------------------------------------------------ |
| `to_entries`       | `to_entries`      | `{"a": 1, "b": 2}`                                 | `[{"key":"a", "value":1}, {"key":"b", "value":2}]` | オブジェクトをキーバリュー型の配列に変換して出力する。       |
| `from_entries`     | `to_entries`      | `[{"key":"a", "value":1}, {"key":"b", "value":2}]` | `{"a": 1, "b": 2}`                                 | キーバリュー型の配列をオブジェクトに変換して出力する。       |
| `select(表現)`     | `select(. >= 2)`  | `[1,5,3,0,7]`                                      | `[5,3,7]`                                          | 表現がtrueとなる要素を出力する。                             |
| `map(表現)`        | `map(.+1)`        | `[1,2,3]`                                          | `[2,3,4]`                                          | 各要素について表現を適用する。                               |
| `map_values(表現)` | `map_values(.+1)` | `{"a": 1, "b": 2, "c": 3}`                         | `{"a": 2, "b": 3, "c": 4}`                         | 各要素**の値**について表現を適用する。                       |
| `keys`             | `keys`            | `{"abc": 1, "abcd": 2, "Foo": 3}`                  | `["Foo", "abc", "abcd"]`                           | オブジェクトのキーの配列を出力する。                         |
| `length`           |                   |                                                    |                                                    | 文字列の長さ、配列の要素数、またはオブジェクトのプロパティ数を出力する。 |
| `@csv`<br />`@tsv` |                   |                                                    |                                                    | 配列を、CSVまたはTSV形式に変換する。                         |
| `split(デリミタ)`  | `split(",")`      | `"foo,baa,baz"`                                    | `["foo","baa","baz"]`                              | 文字列を、デリミタで分割して配列に変換する。                 |

## 参考資料

- [jq Manual (development version)](https://stedolan.github.io/jq/manual/)
- [jq コマンドを使う日常のご紹介 - Qiita](https://qiita.com/takeshinoda@github/items/2dec7a72930ec1f658af)
- [とほほのjq入門 - とほほのWWW入門](https://www.tohoho-web.com/ex/jq.html)
- [jqコマンドとシェルスクリプトの上手い速い使い方](https://zenn.dev/ko1nksm/articles/4e93d16b45b5f2#%E5%80%A4%E3%82%92%E5%8F%96%E5%BE%97%E3%81%97%E3%81%9F%E3%81%84%E3%81%A0%E3%81%91%E3%81%AA%E3%82%89-%40sh-%E3%81%8C%E4%BE%BF%E5%88%A9)
