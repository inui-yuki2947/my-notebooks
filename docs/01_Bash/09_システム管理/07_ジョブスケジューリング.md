# Bash/システム管理/ジョブスケジューリング

## アクセス制御

### ファイル

| ファイル          | 概要                                     |
| ----------------- | ---------------------------------------- |
| `/etc/cron.allow` | cronの利用を許可するユーザーを記述する。 |
| `/etc/cron.deny`  | cronの利用を拒否するユーザーを記述する。 |
| `/etc/at.allow`   | atの利用を許可するユーザーを記述する。   |
| `/etc/at.deny`    | atの利用を拒否するユーザーを記述する。   |

- `allow`ファイル、`deny`ファイルの順で、どちらかのファイルのみが適用される。
  両方が存在しない場合は、rootユーザーのみが実行可能となる。

## crontab

### コマンド

|コマンド|概要|
|---|---|
|`crontab`|定期的に実行するジョブを管理する。（crontabファイルを管理する）|

### オプション

| オプション      | 概要                                               |
| --------------- | -------------------------------------------------- |
| `-l`            | crontabファイルを表示する。                        |
| `-e`            | crontabファイルを編集する。                        |
| `-r`            | crontabファイルを削除する。                        |
| `-u ユーザー名` | 編集するユーザーを指定できる。（rootユーザーのみ） |

## crontabファイル

### ファイル

- `/etc/crontab`ファイルは、システム用のcrontabファイルであり、以下のファイルを呼び出す。
  - `/etc/cron.d/`
  - `/etc/cron.hourly/`
  - `/etc/cron.daily/`
  - `/etc/cron.weekly/`
  - `/etc/cron.monthly/`
- `/var/spool/cron`ディレクトリ以下に、ユーザーのcrontabファイルが格納される。

### 書式

```text
分 時 日 月 曜日 コマンド
```

### スケジュールの指定

- `*`で、すべての値にマッチする。
- カンマ区切りで、複数の値を指定できる。
- `*/数値`で、数値の間隔で実行させる。（例：分を`*/10`とすると、10分間隔となる）
- 曜日は、`0`と`7`が日曜である。

### 例

```text
00,30 */2 * * * /usr/local/bin/backup
```

## at

### コマンド

|コマンド|概要|
|---|---|
|`at 日時`|1回限りで実行するジョブを対話的に管理する。|

### 日時形式例

- `22:00`
- `10pm`
- `noon`
- `now + 3 days`

### オプション

| オプション          | 概要                                                    |
| ------------------- | ------------------------------------------------------- |
| `-f ファイル名`     | 実行するコマンドを記述したファイルを読み込む。          |
| `-l`                | 予約中のジョブの一覧を表示する。（`atq`コマンドと同じ） |
| `-d, -r ジョブ番号` | 予約中のジョブを削除する。（`atrm`コマンドと同じ）      |

### 参考資料

- [Macでatコマンドが実行できないときの対処法 - Qiita](https://qiita.com/shge/items/6c43947a77abd9d2d1b2)

## systemd-run

### timerユニット

- systemdのtimerユニットを使うことでも、スケジューリングを設定できる。
- 使用するユニット
  - timerユニット（`XXX.timer`）
  - ジョブ本体のユニット（`XXX.service`）
- timerユニットの種類
  - モノトニックタイマーは、cronに相当。
  - リアルタイムタイマーは、atに相当。
- `systemctl list-timers`コマンドは、全ての有効なtimerユニットを表示する。

### コマンド

|コマンド|概要|
|---|---|
|`systemd-run`|timerユニットより簡単にジョブスケジューリングができる。|
