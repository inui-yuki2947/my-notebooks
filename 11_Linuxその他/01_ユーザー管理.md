# ユーザー管理

## 一覧表示

### 共通

- コマンド

  |コマンド|概要|
  |---|---|
  |`who`|ログインしているユーザーを表示する。|
  |`w [ユーザー名]`|ログインしているユーザーと**その実行中プロセス**を表示する。|

### who

- オプション

  | オプション   | 概要                                             |
  | ------------ | ------------------------------------------------ |
  | `-m`, `am i` | 標準入力に関連付けられたユーザーのみを表示する。 |

## LDAP

### getent

- **LDAP（Lightweight Directory Access Protocol）**とは、ディレクトリサービスへ接続するためのプロトコルである。

- LDAPを使用している場合は、`getent`コマンドでユーザー・グループ情報を表示する。

  ```bash
  getent 対象
  ```

## 表示

### 共通

- コマンド

  | コマンド          | 概要                                                         |
  | ----------------- | ------------------------------------------------------------ |
  | `id [ユーザー名]` | ユーザーのUIDや所属グループを表示する。<br />ユーザー省略時は実効ユーザーとなる。 |
  | `whoami`          | 自分のユーザー名を表示する。                                 |
  | `groups`          | 自分が所属するグループ一覧を表示する。                       |

### id

- オプション

  | オプション | 概要                               |
  | ---------- | ---------------------------------- |
  | `-u`       | UIDのみ表示する。                  |
  | `-g`       | プライマリーグループのみ表示する。 |
  | `-G`       | 所属グループのみ表示する。         |

## ログイン履歴

### last, lastb, lastlog

- コマンド

  | コマンド             | 概要                                           |
  | -------------------- | ---------------------------------------------- |
  | `last [ユーザー名]`  | システムのログイン履歴の一覧を表示する。       |
  | `lastb [ユーザー名]` | システムのログインエラー履歴の一覧を表示する。 |
  | `lastlog`            | ユーザーごとの最終ログイン情報を表示する。     |

## 設定ファイル

### /etc/passwd, /etc/group

- ファイル

  | ファイル      | 概要                       | 書式                                                         | 例                                         |
  | ------------- | -------------------------- | ------------------------------------------------------------ | ------------------------------------------ |
  | `/etc/passwd` | ユーザー情報が記述される。 | `ユーザー名:パスワード:UID:プライマリグループID:コメント:ホームディレクトリ:ログインシェル` | `user01:x:500:500::/home/user01:/bin/bash` |
  | `/etc/group`  | グループ情報が保存される。 | `グループ名:グループパスワード:GID:サブグループとして属するメンバー` | `hoge_group:x:501:hoge_user3,hoge_user2`   |

- UIDは、rootユーザーは`0`、一般ユーザーは`1000`以降の番号となる。

- コマンド

  |コマンド|概要|
  |---|---|
  |`vipw`|`/etc/passwd`ファイルを安全に編集する。|

### /etc/shadow, /etc/gshadow

- ファイル

  | ファイル       | 概要                                                         |
  | -------------- | ------------------------------------------------------------ |
  | `/etc/shadow`  | ユーザーのシャドウパスワード、及びその有効期限が記述される。 |
  | `/etc/gshadow` | グループのシャドウパスワード、及びその有効期限が記述される。 |

- rootユーザーのみ読み取りできる。

### /etc/skel

- `/etc/skel`ディレクトリには、作成するホームディレクトリのデフォルトファイルを配置する。

## ユーザー編集

### 共通

- コマンド

  | コマンド             | 概要                 |
  | -------------------- | -------------------- |
  | `useradd ユーザー名` | ユーザーを作成する。 |
  | `usermod ユーザー名` | ユーザーを編集する。 |
  | `userdel ユーザー名` | ユーザーを削除する。 |

### useradd

- オプション

  | オプション               | 概要                                                 |
  | ------------------------ | ---------------------------------------------------- |
  | `-g グループ名またはGID` | プライマリグループを指定する。                       |
  | `-G グループ名またはGID` | プライマリグループ以外に所属するグループを指定する。 |
  | `-c コメント`            | コメントを指定する。                                 |
  | `-d パス`                | ホームディレクトリを指定する。                       |
  | `-s パス`                | デフォルトシェルを指定する。                         |

### usermod

- オプション

  | オプション     | 概要                           |
  | -------------- | ------------------------------ |
  | `-L, --lock`   | パスワードをロックする。       |
  | `-U, --unlock` | パスワードのロックを解除する。 |

### userdel

- オプション

  | オプション | 概要                           |
  | ---------- | ------------------------------ |
  | `-r`       | ホームディレクトリも削除する。 |

## ユーザー編集その他

### adduser, deluser

- `adduser, deluser`コマンドは、**対話的に**ユーザーを追加・削除する。

### ログインの禁止

- `/etc/nologin`ファイルを作成すると、rootユーザー以外のログインが禁止される。
  - 同ファイルにメッセージを記述すると、ログインしようとした際にそれが表示される。
- ユーザーのログインシェルを`/bin/false`や`/sbin/nologin`にすると、ログインを禁止できる。
  - `/bin/false`は、ログを出さずにログインを拒否する。
  - `/sbin/nologin`は、ログを出してログインを拒否する。

## グループ編集

### 共通

- コマンド

  | コマンド              | 概要                 |
  | --------------------- | -------------------- |
  | `groupadd グループ名` | グループを作成する。 |
  | `groupmod グループ名` | グループを編集する。 |
  | `groupdel グループ名` | グループを削除する。 |

### groupmod

- オプション

  | オプション      | 概要                   |
  | --------------- | ---------------------- |
  | `-n グループ名` | グループ名を変更する。 |

## パスワード

### passwd, gpasswd

- コマンド

  | コマンド             | 概要                                                       |
  | -------------------- | ---------------------------------------------------------- |
  | `passwd`             | 自身のパスワードを変更する。                               |
  | `passwd ユーザー名`  | 任意のユーザーのパスワードを変更する。（rootユーザーのみ） |
  | `gpasswd グループ名` | グループのパスワードを変更する。                           |

### chage

- コマンド

  |コマンド|概要|
  |---|---|
  |`chage ユーザー名`|パスワード有効期限の管理を行う。|

- オプション

  | オプション              | 概要                                     |
  | ----------------------- | ---------------------------------------- |
  | `-l, --list`            | 現在の状態を表示する。                   |
  | `-d, --lastday 日付`    | パスワードの最終更新日を変更する。       |
  | `-E, --expiredate 日付` | パスワードが無効になる日付を変更する。   |
  | `-m, --mindays 日数`    | パスワード変更間隔の最短日数を変更する。 |
  | `-M, --maxdays 日数`    | パスワードが有効な最長日数を変更する。   |
