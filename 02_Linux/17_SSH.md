# SSH

## 共通

### 概要

- sshクライアントには、TeraTermやPuTTYなどがある。
- sshを受け付けるサーバーには、「sshd」をインストールしておく。

### authorized_keys

- サーバー側の`~/.ssh/authorized_keys`には、公開鍵を記載する。
- 特定のコマンドしか実行させたくない場合

  ```text
  command=コマンド
  ```

### sshd_config

- SSHの設定は、`/etc/ssh/sshd_config`で行う。
- 設定を反映するには、

  ```bash
  sudo systemctl restart sshd
  ```

### sshd_configのよく使う設定

- SSHの**22番ポート**は攻撃を受けやすいので、別の番号に変更すべき。

  ```text
  Port 10022
  ```

- SSHでは、rootユーザーのログインは禁止すべき。

  ```text
  PermitRootLogin no
  ```

- 危険な認証方式の無効化。

  ```text
  PasswordAuthentication no 
  ChallengeResponseAuthentication no
  ```

- SSHでは、パスワード認証ではなく、公開鍵認証を使うべき。

  ```text
  PubkeyAuthentication yes
  ```

### ssh

- 書式

  ```bash
  ssh [ユーザー名@]ホスト名　[コマンド]
  ```

- ポートフォワード
  - ポート番号としては、49152-65535までの番号を使うと良い。
  - `-L`オプション
    - ローカルフォワードを行うことができる。
    - 入り口がローカル、出口が踏み台に置かれる。

    ```bash
    ssh 踏み台ホスト -L 入り口のポート:出口のホスト:出口のポート
    ```

  - `-R`オプション
    - リモートフォワードを行うことができる。
    - 入り口が踏み台、出口がローカルに置かれる。

    ```bash
    ssh 踏み台ホスト -R 入り口のポート:出口のホスト:出口のポート
    ```

- `-i 秘密鍵ファイル`オプションで、秘密鍵を指定できる。（デフォルトは`~/.ssh/id_rsa`）
- `-g`オプションで、ローカル以外でもポートフォワードを行うことができる。
- `-N`オプションで、シェルを開かないようにできる。
- `-f`オプションで、プロセスがバックグラウンドで実行される。
- `-A`オプションで、エージェント転送を行うことができる。 （1つ目のサーバに接続後、続けて別のサーバに接続する際に、最初に使った秘密鍵をそのまま使用する）

### autossh

- `autossh`コマンドは、自動で再接続を行うように`ssh`を実行できる。
