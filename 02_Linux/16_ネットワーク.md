# ネットワーク

## 基本

### IPv6

- IPv6のIPアドレスは、`:`によって区切られた、16ビットずつ8つのブロックで表す。

  - 各ブロックの先頭`0`は省略できる。
  - `0`が連続するブロックは、`:`と表記できる。
  - 例

    ```text
    2001:db8:85a3::8a2e:370:7334
    ```

- 種類
  - ユニキャストアドレスは、1つのネットワークインターフェースを識別するアドレス。
  - エニーキャストアドレスは、複数のホストの集合に割り当てられるアドレス。
  - マルチキャストアドレスは、ブロードキャストアドレスに相当するアドレス。
  
- ポート番号を併記する場合は、IPアドレス部分を`[]`で囲う。
  （例：`[2001:db8:85a3:8d3:1319:8a2e:370:7348]:443`）

### ホスト名・ドメイン名

- `http://www.example.co.jp`の場合
  - `www`がホスト名。
  - `example.co.jp`がドメイン名。
    - `jp`がトップレベルドメイン（TLD）。
    - `co`がセカンドレベルドメイン（2LD）。
    - `example`がサードレベルドメイン（3LD）。
  - `www.example.co.jp`が完全修飾ドメイン名（FQDN）。
- [用語集「ドメイン・ホスト名とは？」](https://www.cman.jp/network/term/domain/)

## ネットワークインターフェース

### 設定ファイル

- `/etc/services`ファイルには、ポート番号とサービスの対応が記述されている。
- `/etc/network/interfaces`ファイルには、Debian系ディストリビューションで、ネットワークインターフェースの設定を記述する。
- `/etc/sysconfig/network-scripts`ファイルには、Red Hat系ディストリビューションで、ネットワークインターフェースの設定を記述する。

### nmcli

- Red Hat系ディストリビューションでは、NetworkManagerというネットワーク管理システムが導入されている。

- `nmcli`コマンドは、NetworkManagerの設定を行う。

  ```bash
  nmcli オブジェクト [コマンド]
  ```

- オブジェクト
  - `general`は、操作一般。
  - `networking`は、ネットワーク管理全般。
  - `radio`は、無線ネットワーク。
  - `connection`は、接続。
  - `device`は、デバイス。

### ifconfig|ipconfig

- `ifconfig`コマンドは、ネットワークインターフェースの表示・設定を行う。

  ```bash
  ifconfig [ネットワークインターフェース名] [パラメータ]
  ```

- Windowsでは、代わりに`ipconfig`コマンドを使う。

### ifup|ifdown

- `ifup`, `ifdown`コマンドは、ネットワークインターフェースを有効・無効にする。

  ```bash
  ifup|ifdown [ネットワークインターフェース名]
  ```

### ip

- `ip`コマンドは、ネットワークデバイスやルーティング、ポリシーなどの表示と変更を行う。

  ```bash
  ip オブジェクト [サブコマンド]
  ```

- オブジェクト
  - `l|link`：データリンク層
  - `a|addr|address`：IPアドレス
  - `r|route`：ルーティングテーブル
  
- サブコマンド
  - `show`：表示する。（省略時のデフォルト）
  - `add`：設定する。
  
- `eth0`などを「インタフェース名」と呼び、環境によって様々な種類がある。
  また`lo`は「ローカルループバック」のことである。
  
- 従来はifconfig、netstat、routeコマンドなどを使用していたが、現在はいずれもipコマンドへの移行が進んでいる。
  [【 ip 】コマンド（基礎編）――ネットワークデバイスのIPアドレスを表示する：Linux基本コマンドTips（146） - ＠IT](https://www.atmarkit.co.jp/ait/articles/1709/22/news019.html)

## ネットワークの状態

### netstat

- `netstat`コマンドは、ネットワークの各種状態を表示する。

  ```bash
  netstat
  ```

- `-a`オプションで、全てのソケット情報を表示する。
- `-r`オプションで、ルーティングテーブルを表示する。
- `-t`オプションで、TCPポートのみ表示する。
- `-u`オプションで、UDPポートのみ表示する。

### ss

- `ss`コマンドは、ネットワークの各種状態を表示する。

  ```bash
  ss [フィルター]
  ```

## ホスト名

### 設定ファイル

- `/etc/hostname`ファイルには、ホスト名を記述する。
- `/etc/hosts`ファイルには、ホスト名とIPアドレスの対応を記述する。

### hostnamectl

- `hostnamectl`コマンドは、ホスト名を設定する。

  ```bash
  hostnamectl [サブコマンド]
  ```

- `status`サブコマンドまたはサブコマンドを省略すると、ホスト名と関連情報を表示する。
- `set-hostname ホスト名`サブコマンドは、ホスト名を設定する。

### hostname

- `hostname`コマンドは、ホスト名を表示する。

  ```bash
  hostname
  ```

- `hostname ホスト名`コマンドは、ホスト名を変更する。

  ```bash
  hostname ホスト名
  ```

## ルーティング

### ICMP

- ICMP（Internet Control Message Protocol）は、エラー報告プロトコルで、`ping`や`traceroute`コマンドで使われる。

### ping|ping6

- `ping|ping6`コマンドは、宛先までIPパケットが届くか確認できる。

  ```bash
  ping|ping6 FQDNまたはIPアドレス
  ```

- `-c 回数`オプションで、送信する回数を指定できる。

- `-i 間隔`オプションで、送信する間隔を指定できる。

### route

- `route`コマンドは、ルーティングテーブルを表示する。（`ip route`コマンドと同じ）

  ```bash
  route
  ```

- `route add`コマンドは、ルーティングテーブルに経路を追加する。

  ```bash
  route add 宛先IPアドレス [gw ゲートウェイのIPアドレス] [reject] [[dev] インタフェース]
  ```

- `route del`コマンドは、ルーティングテーブルの経路を削除する。

  ```bash
  route del 宛先IPアドレス [gw ゲートウェイのIPアドレス] [[dev] インタフェース]
  ```

- オプション
  - `-4`オプションで、IPv4の情報を表示・操作する。（デフォルト）
  - `-6`オプションで、IPv6の情報を表示・操作する。

### traceroute|traceroute6

- `traceroute|traceroute6`コマンドは、パケットが伝わる経路を表示する。

  ```bash
  traceroute|traceroute6 FQDNまたはIPアドレス
  ```

### tracepath|tracepath6

- `tracepath|tracepath6`コマンドは、パケットが伝わる経路と**経路のMTU（Maximum Transmission Unit）**を表示する。

  ```bash
  tracepath|tracepath6 FQDNまたはIPアドレス
  ```

## DNS

### 設定

- `/etc/resolv.conf`ファイルには、参照先のDNSサーバを記述する。
- `/etc/nsswitch.conf`ファイルには、名前解決を行う順序を記述する。
- `/etc/systemd/resolved.conf`ファイルは、systemdを採用したシステムで、systemd-resolvedサービスの設定を行う。

### host

- `host`コマンドは、ホストやドメインに関する情報を、**簡易的に**表示する。

  ```bash
  host FQDNまたはIPアドレス [DNSサーバ]
  ```

- 例

  ```bash
  host www.google.co.jp 8.8.8.8
  ```

### dig

- `dig`コマンドは、ホストやドメインに関する情報を、**詳しく**表示する。

- 正引きをする場合

  ```bash
  dig [@DNSサーバ] FQDN [クエリタイプ] [クエリクラス]
  ```

- 逆引きをする場合

  ```bash
  dig [@DNSサーバ] -x IPアドレス [クエリタイプ] [クエリクラス]
  ```

- クエリタイプ

  - `a`は、ネットワークアドレス。（デフォルト）
  - `any` は、全ての情報。
  - `mx`は、メールサーバの情報。
  - `ns`は、ネームサーバの情報。

- クエリオプション

  - クエリオプションは、`@DNSサーバ`の後、または末尾に記述する。
  - `+short`オプションで、IPアドレスのみを表示する。

- 例

  ```bash
  dig @8.8.8.8 www.google.co.jp +short
  ```

### nslookup

- `nslookup`コマンドは、ホストやドメインに関する情報を、**見やすく加工して**表示する。

  ```bash
  nslookup [FQDNまたはIPアドレス] [DNSサーバ]
  ```

- 例

  ```bash
  nslookup www.google.co.jp 8.8.8.8
  ```

### whois

- `whois`コマンドは、ドメインの所有者やネームサーバ、登録日などの情報を表示する。

  ```bash
  whoid ドメイン名またはIPアドレス
  ```

- 例

  ```bash
  whois google.co.jp
  ```

## データ送信

### curl

- `curl`コマンドは、サーバにデータを送信する。

  ```bash
  curl URL
  ```

- `-X, --request メソッド`オプションで、メソッドを指定できる。

- `-d, -data データ`オプションで、リクエストパラメータを指定できる。

- `-L, --location`オプションで、リダイレクトに追従する。

- `-H, --header ヘッダー`オプションで、ヘッダーを指定できる。

  ```bash
  curl -H 'Content-Type: application/json' ...
  ```

### wget

- `wget`コマンドは、指定したURLのファイルをダウンロードする。

  ```bash
  wget URL
  ```

- `curl`コマンドと違って、再帰的なダウンロードが可能である。

## SSH

### 概要

- sshクライアントには、TeraTermやPuTTYなどがある。
- sshを受け付けるサーバーには、「sshd」をインストールしておく。

### authorized_keys

- サーバー側の`~/.ssh/authorized_keys`には、公開鍵を記載する。
- 特定のコマンドしか実行させたくない場合

  ```text
  command=コマンド
  ```

### sshd_config

- SSHの設定は、`/etc/ssh/sshd_config`で行う。
- 設定を反映するには、

  ```bash
  sudo systemctl restart sshd
  ```

### sshd_configのよく使う設定

- SSHの**22番ポート**は攻撃を受けやすいので、別の番号に変更すべき。

  ```text
  Port 10022
  ```

- SSHでは、rootユーザーのログインは禁止すべき。

  ```text
  PermitRootLogin no
  ```

- 危険な認証方式の無効化。

  ```text
  PasswordAuthentication no 
  ChallengeResponseAuthentication no
  ```

- SSHでは、パスワード認証ではなく、公開鍵認証を使うべき。

  ```text
  PubkeyAuthentication yes
  ```

### ssh

- 書式

  ```bash
  ssh [ユーザー名@]ホスト名　[コマンド]
  ```

- ポートフォワード
  - ポート番号としては、49152-65535までの番号を使うと良い。
  - `-L`オプション
    - ローカルフォワードを行うことができる。
    - 入り口がローカル、出口が踏み台に置かれる。

    ```bash
    ssh 踏み台ホスト -L 入り口のポート:出口のホスト:出口のポート
    ```

  - `-R`オプション
    - リモートフォワードを行うことができる。
    - 入り口が踏み台、出口がローカルに置かれる。

    ```bash
    ssh 踏み台ホスト -R 入り口のポート:出口のホスト:出口のポート
    ```

- `-i 秘密鍵ファイル`オプションで、秘密鍵を指定できる。（デフォルトは`~/.ssh/id_rsa`）
- `-g`オプションで、ローカル以外でもポートフォワードを行うことができる。
- `-N`オプションで、シェルを開かないようにできる。
- `-f`オプションで、プロセスがバックグラウンドで実行される。
- `-A`オプションで、エージェント転送を行うことができる。
  （1つ目のサーバに接続後、続けて別のサーバに接続する際に、最初に使った秘密鍵をそのまま使用する）

### autossh

- `autossh`コマンドは、自動で再接続を行うように`ssh`を実行できる。

## その他

### nc

- `nc`コマンドは、`cat`コマンドと同様の働きをネットワーク上で行う。

  ```bash
  nc [ホスト] [ポート番号]
  ```

### nethogs, iftop

- `nethogs`コマンドで、どのプロセスの通信量が多いかを調べることができる。
- `iftop`コマンドで、どの通信相手との通信量が多いかを調べることができる。
