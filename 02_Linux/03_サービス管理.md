# サービス管理

## 電源管理

### shutdown

- `shutdown`コマンドで、システムのシャットダウンや再起動ができる。（root権限が必要）

  ```bash
  shutdown 時間 [メッセージ]
  ```

- 時間の指定方法
  - `now`で、即実行を行う。
  - `+分`で、その分数後に実行を行う。
  - `hh:mm`で、その時刻に実行を行う。
- 当コマンド実行後は、ユーザーがログインできなくなる。
- オプション
  - `-k`オプションで、実際にシャットダウンせず、警告メッセージだけを表示する。
  - `-r, --reboot`オプションで、再起動を行う。
  - `-c`オプションで、実行のキャンセルを行う。

### systemctl

- `systemctl poweroff`コマンドは、システムをシャットダウンする。
- `systemctl reboot`コマンドは、システムを再起動する。

### ACPI

- ACPI（Advanced Configuration and Power Interface）は、コンピュータの電源を管理する規格である。

## SysVinit

### 概要

- SysVinitでは、最初のプロセス（PID: 1）であるinitが、設定ファイル`/etc/inittab`に基づいて、必要なサービスを起動していく。
- SysVinitでは、あらかじめ決められた順にサービスが起動していくため、プロセスが遅くなりやすいというデメリットがある。

### スクリプトファイル

- SysVinitでは、起動スクリプトとして`/etc/init.d`ディレクトリ以下のファイルが使われる。
- 各ランレベルで起動・終了するサービスのスクリプトファイルは、`/etc/rcランレベル.d`（例：`/etc/rc1.d`）に存在する。

### ランレベル

- SysVinitでは、ランレベルごとに、どのようなサービスが稼働するかを決定する。
  - `0`：停止
  - `1, s, S`：シングルユーザーモード（rootユーザーだけが利用できる特殊な状態）
  - `2 ~ 5`：マルチユーザーモード
  - `6`：再起動
- デフォルトのランレベルは、`/etc/inittab`に記述されている。

### runlevel

- `runlevel`コマンドは、現在のランレベルとその前のランレベルを表示する。

  ```bash
  runlevel
  ```

### init, telinit

- `init, telinit`コマンドは、ランレベルを変更する。

  ```bash
  init ランレベル
  ```

## systemd

### 概要

- systemdを採用したシステムでは、initプロセスの代わりに、systemdプロセスが起動する。
- systemdでは、各種サービスの依存関係や順序関係を処理できる。

### スクリプトファイル

- systemdでは、システムの起動処理は、多数の**Unit**と呼ばれる処理単位に分かれている。
- `/lib/systemd/system`ディレクトリには、オリジナルのスクリプトファイルが配置される。
- `/etc/systemd/system`ディレクトリには、ホストごとに修正されたスクリプトファイルが配置される。
- システムが起動すると、まず`/etc/systemd/system/default.target`というUnitが処理される。

### systemctl

- `systemctl`コマンドは、systemdでサービスを管理できる。

  ```bash
  systemctl サブコマンド [Unit名]
  ```

- 起動・終了系サブコマンド
  - `start`は、サービスを起動する。
  - `stop`は、サービスを終了する。
  - `restart`は、サービスを再起動する。

- 自動起動系サブコマンド
  - `enable`は、サービスの自動起動を有効にする。
  - `disable`は、サービスの自動起動を無効にする。

- 動作モード系サブコマンド
  - `get-default`は、デフォルトのモードを表示する。
  - `set-default ターゲット`は、デフォルトのモードを変更する。

- serviceタイプのUnitの場合、Unit名の`.service`は省略できる。

### service

- `service`コマンドは、単にシェルを実行する形で、サービスの起動や停止、状態確認などを行う。

  ```bash
  service Unit名 サブコマンド
  ```

- `service`より`systemctl`コマンドを使うことが望ましい。
  [Linuxのコマンド実行で使うserviceとsystemctlの違いとは何か？ | CodeLog](https://www.toumasu-program.net/qfr8l41pigu2v05ztwbc)

### launchctl

- Macでは、`launchctl`コマンドでサービスを管理できる。

  ```bash
  launchctl サブコマンド
  ```

### journalctl

- `journalctl`コマンドで、Unitのログを確認できる。

  ```bash
  journalctl
  ```

- `-k`オプションで、カーネルのログのみ出力する。（`dmesg`コマンドと同じ）

- `-u ユニット名`オプションで、指定したユニットのログを出力する。
