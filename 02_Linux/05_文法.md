# 文法

## 基本

### ショートカット

- [bashで覚えておきたいショートカットキー(キーバインド) | 俺的備忘録 〜なんかいろいろ〜](https://orebibou.com/ja/home/201506/20150629_001/)

  分類|ショートカット|内容
  ---|---|---
  移動系|Ctrl + A|行頭に移動する。
  ^|Ctrl + E|行末に移動する。
  編集系|Ctrl + U|行頭まで削除する。
  ^|Ctrl + K|行末まで削除する。
  補完系|Tabを2回|入力補完の候補をすべて表示する。
  ^|Ctrl + R|インクリメンタル検索を行う・選択肢を進める。
  ^|Ctrl + S|インクリメンタル検索の選択肢を戻る※1。
  処理系|Ctrl + C|処理をキャンセルする。
  ^|Ctrl + D|入力の終わりを示す。入力中の文字が存在しなければ終了する。
  ^|Ctrl + Z|処理を一時中断する。
  スクリーンロック系|Ctrl + S|スクリーンロックを行う。
  ^|Ctrl + Q|スクリーンロックを解除する。
  その他|Ctrl + L|画面をクリアする。（Macでログも削除したい場合は「Cmd + K」）

- ※1:通常ではキーバインドがスクリーンロックに割り当てられているので、以下のようにして解除する必要がある。

  ```bash
  stty stop undef
  ```

### コマンド

- [【Linux】コマンドまとめ 〜コマンド名の由来を添えて〜 - Qiita](https://qiita.com/taji-taji/items/0b4bcccf097371bc143c)

### オプション

- [Linux系システムのコマンドラインオプションについて調べたメモ - Qiita](https://qiita.com/rubytomato@github/items/2ee2fd4127eadc1f1193)
- ハイフン1つの場合
  - オプション同士は、連結できる。

    ```bash
    ls -tr
    ```

  - オプション→オプション引数の順は連結でき、オプション引数→オプションの順は連結できない。

    ```bash
    ls -tw100 -r
    ```

- ハイフンが2つの場合
  - オプション引数が必須の場合、半角スペースまたは`=`で区切る。

    ```bash
    ls --sort none
    ls --sort=none
    ```

  - オプション引数が任意の場合、`=`で区切る。

    ```bash
    ls --color=always
    ```

- ハイフンをつける文化の前から存在していたコマンドでは、ハイフンをつけなくてもよいオプションもある。

## 展開とクォーティング

### 概要

- シェルは、クォーテーションで囲まれていないコマンド引数について、パス名展開・チルダ展開・ブレース展開を行う。

### パス名展開

- コマンド引以下のメタキャラクタは、**ファイル名**に置き換えられる。
- `*`：任意の0文字以上
- `?`：任意の1文字
- `[文字1文字2...]`：いずれかの文字
  - [a-z]の形式で、範囲指定もできる。
  - [^文字] もしくは [!文字]で、文字列の否定ができる。

### チルダ展開

- `~ユーザー名`は、指定ユーザーのホームディレクトリに展開される。

### ブレース展開

- `{文字列1,文字列2,...}`で、文字列をそれぞれ展開する。

### パラメータ展開

- デフォルト値
  - `${変数名:-デフォルト値}`で、デフォルト値を設定する。
- 切り出し
  - `${変数名:n:m}`で、変数のn文字目からm文字目まで切り出す。（0始まり）
  - `${変数名#文字列}`で、変数の一部分を、前方一致で取り除く。
  - `${変数名%文字列}`で、変数の一部分を、後方一致で取り除く。
- 置換
  - `${変数名/置換前/置換後}`で、変数を置換する。
  - `${変数名//置換前/置換後}`で、変数を置換する。（複数回）

### コマンド置換

- `` `コマンド` ``または`$(コマンド)`で、コマンドの結果で置換される。
- `$(コマンド)`の方がネストができるため推奨である。

### プロセス置換

- プロセス置換は、コマンドの結果を仮想的なファイルとして利用できる。
（コマンドの結果が、自動的に作成された**ファイルパス名**に置換される）
- 使い道としては、2つ以上ファイルを指定するコマンド（「diff」コマンドなど）で使用する。

  ```bash
  diff <(ls .) <(ls ..)
  ```

### 履歴展開

- 履歴展開は、対話的シェルでのみ行われる。
- `!コマンド履歴番号`は、コマンド履歴の当該番号に展開される。
- `!!`は、直前のコマンドに展開される。
- `!文字列`は、当該文字列で始まる最後のコマンドに展開される。


### その他

- 信頼できない変数（下記など）を参照する場合は、単語分割やパス名展開を防ぐため、またセキュリティ対策のため、**`""`で囲んでおく**。
  - 外側から渡される引数
  - 環境変数
  - コマンドの実行結果

## 算術計算

### 整数型変数

- `declare -i`コマンドで、整数型の変数を定義できる。

  ```bash
  declare -i 変数名[=値]
  ```

- 整数型変数への代入

  - 右辺は、算術式評価される。
  - 右辺は、スペースを含めない。
  
- 例

  ```bash
  declare -i a
  a=b+1
  ```

### ((式))

- `((式、または式を含む代入式))`で、式の算術式評価がなされる。
- 式では、スペースを含めても含めなくてもよい。
- 終了ステータス
  - 結果が`0`の場合は、`1`を返す。
  - 結果が`0`以外の場合は、`0`を返す。

### $((式))

- `$((式))`で、式の算術式評価の結果に展開される。（算術式展開）
- 式では、スペースを含めても含めなくてもよい。

### 算術式評価

- `*, >>, |`などは、算術式の演算子とみなされる。
- 変数名の前の`$`は、付けなくてもよい。

### expr

- `expr`コマンドは、式を評価し標準出力する。

  ```bash
  expr 式
  ```

- 式には、スペースを含める。
- `*`を使う場合は、パス名展開されないようクォートする。

  ```bash
  expr 2 "*" 3
  ```

### let

- `let`コマンドは、式を評価し代入する。

  ```bash
  let 変数=式
  ```

- 式には、スペースを含めない。

## 制御構造

### test, [ 条件 ], [[ 条件 ]]

- `test, [ 条件 ], [[ 条件 ]]`は、判定した結果を**終了ステータス**として返す。
- `test`, `[ 条件 ]`
  - 条件のAND, OR条件として、`-a, -o`を使う。
  - `<, >, (, )`などの記号は、クォートする必要がある。
- `[[ 条件 ]]`（推奨）
  - 条件のAND, OR条件として、`&&, ||`を使う。
  - 条件部分で、単語分割は行われない。
  - 条件部分で、パス名展開は行われない。（比較時の右辺にある場合を除く）

### 評価演算子

- 文字列評価
  - `文字列1 = 文字列2`は、文字列が等しいかどうか。
  - `-n 文字列`は、文字列が空文字でないかどうか。
  - `-z 文字列`は、文字列が空文字であるかどうか。
- 整数評価
  - `整数1 -eq 整数2`は、整数が等しいかどうか。
  - `整数1 -lt 整数2`は、整数1が整数2より小さいかどうか。
  - `整数1 -le 整数2`は、整数1が整数2以下であるかどうか。
- ファイル・ディレクトリ評価
  - `-e パス`は、パスが存在するかどうか。
  - `-f パス`は、ファイルとして存在するかどうか。
  - `-d パス`は、ディレクトリとして存在するかどうか。
  - `-L パス`は、シンボリックリンクとして存在するかどうか。

### if文

- 複数行で書く場合

  ```bash
  if 条件1; then 
    処理1
  elif 条件2; then
    処理2
  else
    処理3
  fi
  ```

- 1行で書く場合

  ```bash
  if 条件; then 処理; fi
  ```

- if文では、条件部分の**終了ステータス**をもとに判断する。
- if文の中身は空にできないので、不要な場合はヌルコマンドを置く。

### case文

- 書式

  ```bash
  case 文字列 in
    パターン1) 
      処理
      ;;
    パターン2) 
      処理
      ;;
  done
  ```

### for文

- 書式

  ```bash
  for 変数 in 配列; do 
    処理
  done
  ```

### while, until文

- while, until文は、条件の終了ステータスが`0 (1)`である限り、処理が繰り返される。

  ```bash
  while 条件; do 
    処理
  done
  ```

### 関数

- 関数の定義（括弧内には引数を表記しない）

  ```bash
  関数名() { 
    処理
  }
  ```

- 関数の呼び出し

  ```bash
  関数名 引数1 引数2 ...
  ```

- 関数呼び出しより関数定義を先に書く。
- 環境変数`FUNCNAME`で、関数名を取得できる。

### グループコマンド

- グループコマンドを使うと、複数のコマンドの標準出力をまとめることができる。
- 波括弧を使うと、**カレントシェル**で実行する
  - 複数行で書く場合

    ```bash
    {
      コマンド1
      コマンド2
      ...
    }
    ```

  - 1行で書く場合（セミコロン必須）

    ```bash
    { コマンド1 ; コマンド2 ; ... ; }
    ```

- 丸括弧を使うと、**サブシェル**で実行する
  - 複数行で書く場合

    ```bash
    (
      コマンド1
      コマンド2
      ...
    )
    ```

  - 1行で書く場合

    ```bash
    ( コマンド1 ; コマンド2 ; ... )
    ```

- サブシェルでは、シェル変数・環境変数は引き継がれるが、サブシェル内での変更は反映されない。

## リダイレクトとパイプ

### ファイルディスクリプタ

- `0,1,2`はそれぞれ、標準入力・標準出力・標準エラー出力を表す。

### リダイレクト

- `n>&m`で、n番のリダイレクトをm番にすることができる。

- `1>`の`1`は省略可能である。

- リダイレクトの変更は、記述した順に行われる。（順不同ではない）

- 標準エラー出力を、標準出力に出力する場合

  ```bash
  コマンド 2>&1
  ```

- 標準エラー出力を標準出力に出力し、標準出力をファイルに出力する場合

  ```bash
  コマンド 2>&1 > ファイル
  ```

- 標準出力・エラー出力を、まとめてファイルに出力する場合

  ```bash
  コマンド > ファイル 2>&1
  ```

- 標準出力・エラー出力を、まとめてファイルに出力する場合（省略記法）

  ```bash
  コマンド &> ファイル
  ```

### パイプライン

- 標準出力・エラー出力を、まとめてパイプする場合

  ```bash
  コマンド 2>&1 | コマンド
  ```

- 標準出力・エラー出力を、まとめてパイプする場合（省略記法、BSDでは使えない？）

  ```bash
  コマンド |& コマンド
  ```

### ヒアドキュメント

- ヒアドキュメントの内容は、コマンドの**標準入力**として実行される。

  ```bash
  コマンド << 終了文字列
    ヒアドキュメントの内容
  終了文字列
  ```

- 終了文字列としては、`EOF`などがよく使われる。
- ヒアドキュメントの内側では、パラメータ展開・コマンド置換・算術式展開が行われる。
- 展開をさせたくない場合は、終了文字列をクォートする。

### ヒアストリング

- 書式

  ```bash
  コマンド <<< 文字列
  ```

### tee

- `tee`コマンドは、標準入力を、標準出力とファイルに出力する。

  ```bash
  tee [ファイル名...]
  ```

- `-a`オプションで、ファイルに上書きでなく追記する。
- 複数ファイルに同じ内容を出力したいときに有用である。

### xargs

- `xargs`コマンドは、標準入力を、指定したコマンドの引数として渡す。

  ```bash
  xargs コマンド
  ```

- 引数をコマンド置換で指定する場合と比べ、以下のような利点がある。
  - 引数が長くなる場合にも対応できる。
- 標準入力が空であった場合
  - BSD系では、コマンドは実行されない。（終了ステータスは0）
  - GNU系では、コマンドは実行される。（`--no-run-if-empty`オプションで、実行させないようにできる）
- `-I 置換文字列`オプションで、引数を任意の位置に挿入できる。（`{}`などをよく使う？）

  ```bash
  xargs -I {} コマンド 引数 {}
  ```

- `-0`オプションで、ヌル文字を区切り文字として扱う。

  ```bash
  find . -name '*.txt' -print0 | xargs -0 ls
  ```

## シェルスクリプト

### シバン

- シェルスクリプトの1行目では、`#!`から始まる**シバン**でインタープリターを指定する。

  ```bash
  #!/bin/bash
  ```

- シバンは、スクリプトファイルを直接実行する場合のみ読み込まれる。

### シェルスクリプトの実行

- シェルスクリプトは、ファイルを直接実行するか、`bash, source, .`コマンドを使用して実行できる。
- ファイルを直接実行する場合は、実行権限が必要。

  ```bash
  ./hello.sh
  ```

### カレントディレクトリ

- シェルスクリプトのカレントディレクトリは、それを呼び出した際のカレントディレクトリとなるので、以下でシェルスクリプトのカレントディレクトリを統一すると便利。

  ```bash
  cd "$(dirname "$0")" || exit
  ```

### exit, return

- `exit [終了ステータス]`で、**シェルスクリプト全体**の終了ステータスを指定する。
- `return [終了ステータス]`で、**関数**の終了ステータスを指定する。
- 終了ステータス省略時は、`0`となる。
