# Linux

## OS

### Linuxディストリビューション

| 項目            | 例             | 特徴                       |
| --------------- | -------------- | -------------------------- |
| RedHat (RHEL)系 | Fedora, CentOS | 有償で安定性がある。       |
| Debian系        | Ubuntu         | 無償で開発スピードが速い。 |

- 「Alpine Linux」は、軽量なLinuxディストリビューション。

### WSL

- WSL（Windows Subsystem for Linux）とは、Linuxのバイナリ実行ファイルを、Windows 10およびWindows Server上でネイティブ実行するための互換レイヤー。

## Linux起動の流れ

1. BIOS/UEFI
1. ブートローダ
1. カーネル
1. 初期プロセス（SysVinit, Upstart, systemd）

## ハードウェア

### 接続形態

- SATA (Serial ATA)は、現在主流となっている規格である。
- SAS (Serial Attached SCSI)は、SATAよりも高速で信頼性も高い規格である。
- SCSIは、さまざまな周辺機器を接続するための一般的な規格である。
- DMAは、CPUを介することなく、メインメモリと周辺機器の間で直接的に情報転送を行う方式。（`/proc/dma`）
- PCI (Peripheral Component Interconnect)は、コンピュータ内部で装置間を結ぶデータ伝送路の規格の一つ。

### BIOS/UEFI

- BIOSは、キーボードやハードディスクなどのデバイスを制御する、もっとも基本的な制御プログラムである。
- 現在では、BIOSの後継となるファームウェア規格の、UEFI (Unified Extensible Firmware Interface)が普及している。

### lspci

- `lspci`コマンドは、PCIデバイスの情報を表示する。

  ```bash
  lspci
  ```

### lsusb

- `lsusb`コマンドは、USBデバイスの情報を表示する。

  ```bash
  lsusb
  ```

## デバイス

### ブロックデバイスとキャラクタデバイス

- ブロックデバイスは、HDDやSSDなど、メディア上の任意の場所にアクセスできるデバイス。
- キャラクタデバイスは、キーボードやシリアルポートなど、文字単位でアクセスするデバイス。

### lsblk

- `lsblk`コマンドは、ブロックデバイスの一覧を表示する。

  ```bash
  lsblk [デバイス...]
  ```

### blkid

- `blkid`コマンドは、ブロックデバイスの情報を表示する。

  ```bash
  blkid [デバイス...]
  ```

### デバイスファイル

- `/dev/sda, sdb, sdc, sdd`は、1〜4番目のハードディスクである。
- `/dev/sr0`は、1番目のCD/DVDドライブである。
- `/dev/st0`は、1番目のテープドライブである。

### 疑似デバイス

- `/dev/null`は、あらゆる入力を受け付け、それを捨てる。
- `/dev/zero`は、NULL文字を出力する。
- `/dev/random`は、乱数を再利用せず、真の乱数文字列を出力する。
- `/dev/urandom`は、乱数を再利用して、擬似乱数文字列を出力する。

## パーティション

### 概要

- Linuxでは、ハードディスクをいくつかの**パーティション**に分割して利用する。
- `/home, /var`ディレクトリは、別パーティションに分割するべき。
- システムによっては、ディスクの先頭パーティションとして、数100MB程度を`/boot`パーティションに割り当てたほうがよい場合がある。
- UEFIを使ったシステムでは、FATファイルシステムでフォーマットされた、EFIシステムパーティション（ESP）が必要である。

### パーティションの種類

- ディスクには最大4個の基本パーティションを作成できる。（`/dev/sda1~4`）
- 基本パーティションのうちの一つを、拡張パーティションにすることができる。
- 論理パーティションは、拡張パーティションの中に作成されたパーティションのこと。（`/dev/sda5~`）

### スワップ領域

- スワップ領域は、仮想メモリ（物理メモリが不足した場合のメモリの延長）として利用される。
- サイズの目安は、物理メモリの1〜2倍程度。

### MBRとGPT

| 方式                              | 概要                               | コマンド |
| --------------------------------- | ---------------------------------- | -------- |
| MBR（マスターブートレコード）     | 従来のパーティションテーブルの方式 | fdisk    |
| GPT（GUIDパーティションテーブル） | 新しいパーティションテーブルの方式 | gdisk    |

### fdisk, gdisk

- `fdisk, gdisk`コマンドは、パーティションの管理を対話的に行う。

  ```bash
  fdisk デバイス名
  ```

- `-l`オプションで、そのデバイスのパーティションテーブルの状態を表示する。

### parted

- `parted`コマンドは、MBR, GPT方式の両方に対応した、パーティション管理を行う。

  ```bash
  parted デバイス名 [-s サブコマンド]
  ```

### LVM

- 最近では、LVMと呼ばれるディスク管理が行われることもある。

## ファイルシステムの作成

### 概要

- ファイルを保存するためには、パーティション上にファイルシステムを作る必要がある。

### 種類

| 名称                        | 概要                                                         | コマンド   |
| --------------------------- | ------------------------------------------------------------ | ---------- |
| ext4                        | 多くのLinuxディストリビューションの標準ファイルシステム      | mke2fs     |
| Btrfs（B-tree file system） | Linux向けの新しいファイルシステム                            | mkfs.btrfs |
| XFS                         | CentOS 7などで標準となっている、ジャーナリングファイルシステム | mkfs.xfs   |

### mkfs

- `mkfs`コマンドは、パーティション上にファイルシステムを作成する。（各種ファイルシステムのフロントエンド）

  ```bash
  mkfs デバイス名
  ```

- `-t ファイルシステムタイプ`オプションで、ファイルシステムタイプを指定できる。

### mkswap

- `mkswap`コマンドは、パーティション上にスワップ領域を作成する。

  ```bash
  mkswap デバイス名
  ```

## ファイルシステム管理

### iノード

- 作成できるiノードの数は、ファイルシステム作成時に設定され、あとから変更はできない。
- iノードが枯渇すると、ファイルを新規保存できなくなる。

### df

- `df`コマンドは、ファイルシステムの空き容量を表示する。

  ```bash
  df [デバイス名やディレクトリ名]
  ```

### du

- `du`コマンドは、ファイルやディレクトリが占めている容量を表示する。

  ```bash
  du [ファイル名やディレクトリ名]
  ```

- `-a`オプションで、ディレクトリだけでなく、ファイルのディスク使用量も表示する。
- `-s`オプションで、サブディレクトリの情報を非表示にする。
- `-S`オプションで、サブディレクトリの容量を含めない。
- `-h`オプションで、人間に分かりやすい単位で容量を表示する。
- `-i`オプションで、空き容量の代わりに、iノードの使用状況について表示する。

### fsck, e2fsck

- `fsck, e2fsck`コマンドは、ディスクのチェックを行い、必要であれば修復を試みる。

  ```bash
  fsck デバイス名
  ```

- ext2, ext3, ext4には、`e2fsck`コマンドを使う。
- `-A`オプションで、`/etc/fstab`ファイルに記述されている全ファイルシステムをチェックする。

### tune2fs

- `tune2fs`コマンドは、ext2, ext3, ext4の様々なパラメータを指定する。

  ```bash
  tune2fs デバイス名
  ```

- `-c 回数`オプションで、何回マウント後にファイルシステムを検査するか指定できる。
- `-i 間隔`オプションで、ファイルシステムを検査する間隔を指定できる。

## マウントとアンマウント

### mount

- `mount`コマンドは、マウント状況を表示する。

  ```bash
  mount
  ```

### mount デバイス名 マウントポイント

- `mount`コマンドの下記書式は、ファイルシステムをマウントする。

  ```bash
  mount [デバイス名] [マウントポイント]
  ```

- 引数のどちらかを省略すると、`/etc/fstab`ファイルの記述が参照される。
- マウントされたファイルシステムの情報は、`/etc/mtab`に格納される。
- `-a, --all`オプションで、`/etc/fstab`ファイルの全てのデバイスをマウントする。　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　
- `-t ファイルシステムタイプ`オプションで、ファイルシステムタイプを指定できる。

### umount

- `umount`コマンドは、ファイルシステムをアンマウントする。

  ```bash
  umount デバイス名またはマウントポイント
  ```

### /etc/fstab

- 書式

  ```text
  デバイス名   マウントポイント   ファイルシステムの種類   マウントオプション   dumpフラグ   fsckフラグ
  ```

- 例

  ```text
  /dev/sda1        /home           ext4    defaults        1 1
  ```

## Cloud-init

- Cloud-initは、インスタンスを初期化する仕組みである。
- 個々のインスタンスを識別するには、D-BusマシンIDが利用できる。

## ディレクトリ

### 概要

- [Linuxディレクトリ構造 - Qiita](https://qiita.com/nys9302/items/a8ddeedd3cd9d0deb332)

### /dev

- デバイスファイルが格納される。
- udev (Userspace DEVice management)という仕組みによって、自動的に作成される。

### /media

- DVD-ROMなど、リムーバブルメディアのマウントポイントが配置される。

### /mnt

- 一時的にマウントするファイルシステムのマウントポイントが配置される。

### /opt

- パッケージ管理の仕組みによって、プログラムがインストールされる。

### /proc

- カーネルが認識しているデバイスの情報が確認できる。

### /home

- 一般ユーザーがそれぞれ利用するファイルが格納される。

### /root

- rootユーザーが利用するファイルが格納される。

### /var

- 各種ログファイルやメールスプールなど、更新頻度の高いファイルが格納される。

### /usr

- プログラムやライブラリ、ドキュメントが格納される。
- `/usr/bin, /usr/sbin`には、緊急時のシステム管理に必須でないコマンドが配置される。
- `/usr/local`は、更に`bin, sbin lib`などのディレクトリに細分化され、
  ローカルシステムで必要とされるコマンド、自作のコマンドなどが配置される。
- `/usr/share/man`には、マニュアルが配置される。

### /lib

- カーネルやプログラムに必要な各種ライブラリが格納される。

### /etc

- 設定ファイルなどが格納される。

## ブートローダ

### 概要

- ブートローダの主な役割は、起動デバイス上からカーネルをメモリ上に読み込むことである。

### GRUB

- GRUB (GRand Unified Bootloader)は、Linuxの代表的なブートローダである。
- GRUBには以下のバージョンがある。
  - バージョン0.9x系の、GRUB Legacy
  - バージョン1.9x系の、GRUB 2
- 起動時の画面で「E」キーを押すと、ブートオプションを設定できる。

### grub-install

- `grub-install`コマンドで、GRUBをインストールできる。

  ```bash
  grub-install インストールデバイス
  ```

### grub-mkconfig

- `grub-mkconfig`コマンドは、`/etc/default/grub`ファイルをもとに、`/boot/grub/grub.cfg`ファイルを生成する。
- GRUB Legacyでは、当コマンドを使わず、`/boot/grub/menu.lst`ファイルを直接編集する。

## カーネル

### lsmod

- `lsmod`コマンドは、ロードされているカーネルモジュールを表示する。
  （`/proc/modules`ファイルを見やすく表示する）

  ```bash
  lsmod
  ```

### modprobe

- `modprobe`コマンドは、カーネルモジュールのロード・アンロードを行う。

  ```bash
  modprobe [カーネルモジュール名]
  ```

### uname

- `uname`コマンドは、システムのアーキテクチャやOSを表示する。

  ```bash
  uname
  ```

- `-a`オプションで、詳細情報を表示する。

### dmesg

- `dmesg`（display message）コマンドは、システム起動時にカーネルがどのような処理を行ったか確認できる。

  ```bash
  dmesg
  ```
