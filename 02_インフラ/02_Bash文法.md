# Bash文法

## 共通

### 使用するシェル

- `/etc/shells`で、使用可能なシェル一覧を確認できる。
- 環境変数`SHELL`で、デフォルトのシェルを確認できることもあるが、あまり信頼できない。
- `/etc/passwd`でも、デフォルトのシェルを確認できる。

### chsh

- `chsh`コマンドで、デフォルトのシェルを変更できる。

  ```bash
  chsh [ユーザー（省略時はカレントユーザー）]
  ```

### プロンプト

- 環境変数`PS1`で、プロンプトを設定できる。（デフォルトは`\h:\W \u\$`）
- 環境変数`PS2`で、セカンダリプロンプト（2行目以降のプロンプト）を設定できる。

### ショートカット

- [bashで覚えておきたいショートカットキー(キーバインド) | 俺的備忘録 〜なんかいろいろ〜](https://orebibou.com/ja/home/201506/20150629_001/)

  分類|ショートカット|内容
  ---|---|---
  移動系|Ctrl + A|行頭に移動する。
  ^|Ctrl + E|行末に移動する。
  編集系|Ctrl + U|行頭まで削除する。
  ^|Ctrl + K|行末まで削除する。
  補完系|Tabを2回|入力補完の候補をすべて表示する。
  ^|Ctrl + R|インクリメンタル検索を行う・選択肢を進める。
  ^|Ctrl + S|インクリメンタル検索の選択肢を戻る※1。
  処理系|Ctrl + C|処理をキャンセルする。
  ^|Ctrl + D|入力の終わりを示す。入力中の文字が存在しなければ終了する。
  ^|Ctrl + Z|処理を一時中断する。
  スクリーンロック系|Ctrl + S|スクリーンロックを行う。
  ^|Ctrl + Q|スクリーンロックを解除する。
  その他|Ctrl + L|画面をクリアする。

- ※1:通常ではキーバインドがスクリーンロックに割り当てられているので、以下のようにして解除する必要がある。

  ```bash
  stty stop undef
  ```

### コマンド

- [【Linux】コマンドまとめ 〜コマンド名の由来を添えて〜 - Qiita](https://qiita.com/taji-taji/items/0b4bcccf097371bc143c)

### オプション

- [Linux系システムのコマンドラインオプションについて調べたメモ - Qiita](https://qiita.com/rubytomato@github/items/2ee2fd4127eadc1f1193)
- ハイフン1つの場合
  - オプション同士は、連結できる。

    ```bash
    ls -tr
    ```

  - オプション→オプション引数の順は連結でき、オプション引数→オプションの順は連結できない。

    ```bash
    ls -tw100 -r
    ```

- ハイフンが2つの場合
  - オプション引数が必須の場合、半角スペースまたは`=`で区切る。

    ```bash
    ls --sort none
    ls --sort=none
    ```

  - オプション引数が任意の場合、`=`で区切る。

    ```bash
    ls --color=always
    ```

- ハイフンをつける文化の前から存在していたコマンドでは、ハイフンをつけなくてもよいオプションもある。

### bash_profile, bashrc

- [【初心者向け】エイリアスの設定方法 - Qiita](https://qiita.com/yutat93/items/b5bb9c0366f21bcbea62)
- [本当に正しい .bashrc と .bash_profile の使ひ分け - Qiita](https://qiita.com/magicant/items/d3bb7ea1192e63fba850)
- `bash_profile`と`bashrc`

  ファイル|読み込みタイミング|用途
  ---|---|---
  ~/.bash_profile|ログイン時|環境変数の設定
  ~/.bashrc|ログイン以外の対話的シェル起動時|エイリアスの設定、bashオプションの設定

- `bash_profile`から`bash_rc`を読み込むよう記述することもある。

  ```bash
  if [ -f ~/.bashrc ]; then
    . ~/.bashrc
  fi
  ```

## コマンド履歴

### コマンド履歴のフロー

1. Bash起動時に、`~/.bash_history`から読み込まれる。
1. Bash使用中は、キャッシュが使用される。
1. Bash終了時に、`~/.bash_history`に書き込まれる。

### HISTFILE

- 環境変数`HISTFILE`で、コマンド履歴を記録するファイルを指定できる。（デフォルトは`~/.bash_history`）

### history

- `history`コマンドは、コマンド履歴を表示する。
- 削除
  - `-d 削除したい番号`オプションで、特定のコマンド履歴を削除できる。
  - `-c`オプションで、全コマンド履歴を削除できる。
- 上書き
  - `-w [ファイル名]`オプションで、ファイルに上書きできる。
  - `-r [ファイル名]`オプションで、ファイルから上書きできる。
- 追記
  - `-a [ファイル名]`オプションで、ファイルに追記できる。
  - `-n [ファイル名]`オプションで、ファイルから追記できる。

### コマンドの再実行

- `!コマンド履歴番号`コマンドで、特定のコマンド履歴を再実行できる。
- `!!`コマンドで、直前のコマンド履歴を再実行できる。

## 展開とクォーティング

### 概要

- シェルは、クォーテーションで囲まれていないコマンド引数について、パス名展開・チルダ展開・ブレース展開を行う。

### パス名展開

- コマンド引以下のメタキャラクタは、**ファイル名**に置き換えられる。
- `*`：任意の0文字以上
- `?`：任意の1文字
- `[文字1文字2...]`：いずれかの文字
  - [a-z]の形式で、範囲指定もできる。
  - [^文字] もしくは [!文字]で、文字列の否定ができる。

### チルダ展開

- `~ユーザー名`は、指定ユーザーのホームディレクトリに展開される。

### ブレース展開

- `{文字列1,文字列2,...}`で、文字列をそれぞれ展開する。

### パラメータ展開

- デフォルト値
  - `${変数名:-デフォルト値}`で、デフォルト値を設定する。
- 切り出し
  - `${変数名:n:m}`で、変数のn文字目からm文字目まで切り出す。（0始まり）
  - `${変数名#文字列}`で、変数の一部分を、前方一致で取り除く。
  - `${変数名%文字列}`で、変数の一部分を、後方一致で取り除く。
- 置換
  - `${変数名/置換前/置換後}`で、変数を置換する。
  - `${変数名//置換前/置換後}`で、変数を置換する。（複数回）

### コマンド置換

- `` `コマンド` ``または`$(コマンド)`で、コマンドの結果で置換される。
- `$(コマンド)`の方がネストができるため推奨である。

### 算術式評価

- 代入に利用する場合

  ```bash
  $ ((a = 5 + 3))
  $ echo $a
  8
  ```

- 終了ステータスを利用する場合

  ```bash
  $ ((5 < 3))
  $ echo $?
  1
  ```

### 算術式展開

- 書式

  ```bash
  $ echo $((5 + 7))
  12
  ```

### プロセス置換

- プロセス置換では、その部分が自動的に割り当てられた**ファイルパス名**に置換される。
- 使い道としては、2つ以上ファイルを指定するコマンド（「diff」コマンドなど）で使用する。

  ```bash
  diff <(ls .) <(ls ..)
  ```

### その他

- 信頼できない変数（下記など）を参照する場合は、単語分割やパス名展開を防ぐため、またセキュリティ対策のため、**`""`で囲んでおく**。
  - 外側から渡される引数
  - 環境変数
  - コマンドの実行結果

## 制御構造

### testコマンド

- `test`コマンドは、判定した結果を**終了ステータス**として返す。
- `test`コマンドを使用する場合

  ```bash
  test "$hoge" = 'HOGE'
  ```

- 角括弧を使用する場合

  ```bash
  [ "$hoge" = 'HOGE' ]
  ```

- 二重角括弧を使用する場合

  ```bash
  [[ "$hoge" = 'HOGE' ]]
  ```

- 記法としては二重角括弧を優先的に使用すべき（以下のように条件をシンプルに記述できるため）。
  - `&&`、`||`が使える。
  - 単語分割が行われない。
  - パス名展開が行われない。（比較時の右辺にある場合を除く）
- 文字列の比較は`=`で行うが、数値の比較は`-eq`で行う。
- オプション
  - `-e`：パスが存在するか
  - `-f`：ファイルとして存在するか
  - `-d`：ディレクトリとして存在するか
  - `-L`：シンボリックリンクとして存在するか

### if文

- 複数行で書く場合

  ```bash
  if 条件; then 
    処理
  fi
  ```

- 1行で書く場合

  ```bash
  if 条件; then 処理; fi
  ```

- if文では、条件部分の**終了ステータス**をもとに判断する。
- if文の中身は空にできないので、不要な場合はヌルコマンドを置く。

### case文

- 書式

  ```bash
  case 文字列 in
    パターン1) 
      処理
      ;;
    パターン2) 
      処理
      ;;
  done
  ```

### for文

- 書式（複数行で書く場合）

  ```bash
  for 繰り返し条件; do 
    処理
  done
  ```

- 書式（1行で書く場合）

  ```bash
  for 繰り返し条件; do 処理; done
  ```

### 関数

- 関数の定義（括弧内には引数を表記しない）

  ```bash
  関数名() { 
    処理
  }
  ```

- 関数の呼び出し

  ```bash
  関数名 引数1 引数2 ...
  ```

- 関数呼び出しより関数定義を先に書く。
- 環境変数`FUNCNAME`で、関数名を取得できる。

### グループコマンド

- グループコマンドを使うと、複数のコマンドの標準出力をまとめることができる。
- 波括弧を使うと、**カレントシェル**で実行する
  - 複数行で書く場合

    ```bash
    {
      コマンド1
      コマンド2
      ...
    }
    ```

  - 1行で書く場合（セミコロン必須）

    ```bash
    { コマンド1 ; コマンド2 ; ... ; }
    ```

- 丸括弧を使うと、**サブシェル**で実行する
  - 複数行で書く場合

    ```bash
    (
      コマンド1
      コマンド2
      ...
    )
    ```

  - 1行で書く場合

    ```bash
    ( コマンド1 ; コマンド2 ; ... )
    ```

- サブシェルでは、シェル変数・環境変数は引き継がれるが、サブシェル内での変更は反映されない。

## リダイレクトとパイプ

### ファイルディスクリプタ

- `0,1,2`はそれぞれ、標準入力・標準出力・標準エラー出力を表す。

### リダイレクト

- `n>&m`で、n番のリダイレクトをm番にすることができる。

- `1>`の`1`は省略可能である。

- リダイレクトの変更は、記述した順に行われる。（順不同ではない）

- 標準エラー出力を、標準出力に出力する場合

  ```bash
  コマンド 2>&1
  ```

- 標準エラー出力を標準出力に出力し、標準出力をファイルに出力する場合

  ```bash
  コマンド 2>&1 > ファイル
  ```

- 標準出力・エラー出力を、まとめてファイルに出力する場合

  ```bash
  コマンド > ファイル 2>&1
  ```

- 標準出力・エラー出力を、まとめてファイルに出力する場合（省略記法）

  ```bash
  コマンド &> ファイル
  ```

### パイプライン

- 標準出力・エラー出力を、まとめてパイプする場合

  ```bash
  コマンド 2>&1 | コマンド
  ```

- 標準出力・エラー出力を、まとめてパイプする場合（省略記法、BSDでは使えない？）

  ```bash
  コマンド |& コマンド
  ```

### ヒアドキュメント

- ヒアドキュメントの内容は、コマンドの**標準入力**として実行される。

  ```bash
  コマンド << 終了文字列
    ヒアドキュメントの内容
  終了文字列
  ```

- 終了文字列としては、`EOF`などがよく使われる。
- ヒアドキュメントの内側では、パラメータ展開・コマンド置換・算術式展開が行われる。
- 展開をさせたくない場合は、終了文字列をクォートする。

### ヒアストリング

- 書式

  ```bash
  コマンド <<< 文字列
  ```

### tee

- `tee`コマンドは、標準入力を、標準出力とファイルに出力する。

  ```bash
  tee [ファイル名...]
  ```

- `-a`オプションで、ファイルに上書きでなく追記する。
- 複数ファイルに同じ内容を出力したいときに有用である。

### xargs

- `xargs`コマンドは、標準入力を、指定したコマンドの引数として渡す。

  ```bash
  xargs コマンド
  ```

- 引数をコマンド置換で指定する場合と比べ、以下のような利点がある。
  - 引数が長くなる場合にも対応できる。
- 標準入力が空であった場合
  - BSD系では、コマンドは実行されない。（終了ステータスは0）
  - GNU系では、コマンドは実行される。（`--no-run-if-empty`オプションで、実行させないようにできる）
- `-I 置換文字列`オプションで、引数を任意の位置に挿入できる。（`{}`などをよく使う？）

  ```bash
  xargs -I {} コマンド 引数 {}
  ```

- `-0`オプションで、ヌル文字を区切り文字として扱う。

  ```bash
  find . -name '*.txt' -print0 | xargs -0 ls
  ```

## シェルスクリプト

### シバン

- シェルスクリプトの1行目では、`#!`から始まる**シバン**でインタープリターを指定する。

  ```bash
  #!/bin/bash
  ```

- シバンは、スクリプトファイルを直接実行する場合のみ読み込まれる。

### シェルスクリプトの実行

- シェルスクリプトは、ファイルを直接実行するか、`bash, source, .`コマンドを使用して実行できる。
- ファイルを直接実行する場合は、実行権限が必要。

  ```bash
  ./hello.sh
  ```

### カレントディレクトリ

- シェルスクリプトのカレントディレクトリは、それを呼び出した際のカレントディレクトリとなるので、以下でシェルスクリプトのカレントディレクトリを統一すると便利。

  ```bash
  cd "$(dirname "$0")" || exit
  ```

### exit, return

- `exit [終了ステータス]`で、**シェルスクリプト全体**の終了ステータスを指定する。
- `return [終了ステータス]`で、**関数**の終了ステータスを指定する。
- 終了ステータス省略時は、`0`となる。
