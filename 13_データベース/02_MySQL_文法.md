# MySQL_文法

## 共通

### 記法

- 複数の値を列挙する場合は、原則カンマ区切りで並べる。

### コメント

- 記法

  ```sql
  -- コメント
  /* コメント */
  ```

### delimiter

- `delimiter`コマンドで、SQLの区切り文字を変更できる。

  ```sql
  delimiter 区切り文字
  ```

- `//`を区切り文字として使うことが多い。

- ストアドプロシージャやトリガーの定義時などに使うと良い。

## 比較

### CAST, CONVERT

- 記法

  | 記法                                            | 概要                   |
  | ----------------------------------------------- | ---------------------- |
  | `CAST(expr AS type)`<br />`CONVERT(expr, type)` | 型をキャストする。     |
  | `CONVERT(expr USING transcoding_name)`          | 文字コードを変換する。 |

### LIKE, REGEXP

- 記法

  | 記法                                                         | 概要                               |
  | ------------------------------------------------------------ | ---------------------------------- |
  | `文字列 LIKE パターン`                                       | 文字列がパターンに一致するか。     |
  | `文字列 REGEXP 拡張正規表現`<br />`文字列 RLIKE 拡張正規表現` | 文字列が拡張正規表現に一致するか。 |

- パターンのワイルドカード

  | ワイルドカード | 概要                        |
  | -------------- | --------------------------- |
  | `%`            | 任意の文字列**0文字以上**。 |
  | `_`            | 任意の文字列**1文字**。     |

### IS NULL

- 記法

  | 記法             | 概要               |
  | ---------------- | ------------------ |
  | `値 IS NULL`     | 値がNULLであるか。 |
  | `値 IS NOT NULL` | 値がNULLでないか。 |

- `NULL`を通常の比較演算子で比較しても、**結果はNULLとなる**。

### 照合順序

- `COLLATE`句で、照合順序をオーバーライドできる。

  ```sql
  SELECT k
  FROM t1
  ORDER BY k COLLATE latin1_german2_ci;
  ```

## 変数

### 共通

- 変数

  | 変数             | 概要                                                       |
  | ---------------- | ---------------------------------------------------------- |
  | システム変数     | システムで定義された変数。                                 |
  | ユーザー定義変数 | ユーザーが定義した、セッション内でのみ有効な変数。         |
  | ローカル変数     | ユーザーが定義した、複合ステートメント内でのみ有効な変数。 |

### ユーザー定義変数

- 記法

  | 記法                                | 概要                                 | 例                                  |
  | ----------------------------------- | ------------------------------------ | ----------------------------------- |
  | `SET @変数名 = 値`                  | ユーザー定義変数を定義する。         | `@var_name = 1`                     |
  | `@変数名`                           | ユーザー定義変数を参照する。         | `SELECT @var_name`                  |
  | `@変数名 := 値`（ステートメント内） | ユーザー定義変数を定義して参照する。 | `SELECT @t1, @t2, @t3 := @t1 + @t2` |

- IN句などで変数を使いたい場合は、代わりに以下のようにするとよい。

  ```sql
  WHERE FIND_IN_SET(値, @カンマ区切り文字列を格納する変数)
  ```

### ローカル変数

- 記法

  | 記法                                          | 概要                     |
  | --------------------------------------------- | ------------------------ |
  | `DECLARE 変数名... 型 [DEFAULT デフォルト値]` | ローカル変数を定義する。 |
  | `変数名`                                      | ローカル変数を参照する。 |

## 複合ステートメント

### 概要

- 複合ステートメント構文は、ストアドプロシージャ、ストアドファンクション、トリガー、およびイベント内で使用する。

  ```sql
  BEGIN
      処理
  END;
  ```

### IF

- 記法

  ```sql
  IF 条件1 THEN
      処理1
  ELSEIF 条件2 THEN
      処理2
  ...
  ELSE
      処理n
  END IF;
  ```

### CASE

- 記法

  ```sql
  CASE 判断値
      WHEN 値1 THEN 処理1
      WHEN 値2 THEN 処理2
      ...
      ELSE 処理n
  END CASE
  ```

### LOOP

- 記法

  ```sql
  [開始ラベル:] LOOP
      処理
  END LOOP [終了ラベル]
  ```

### WHILE

- 記法

  ```sql
  [開始ラベル:] WHILE 継続条件 DO
      処理
  END WHILE [終了ラベル]
  ```

### REPEAT

- 記法

  ```sql
  [開始ラベル:] REPEAT
      処理
  UNTIL 終了条件 END REPEAT [終了ラベル]
  ```

### ITERATE, LEAVE, RETURN

- `ITERATE`文は、指定したラベルのループを再び開始する。

  ```sql
  ITERATE ラベル
  ```

- `LEAVE`文は、特定のラベルを持つフロー制御構文を終了する。（最も外側の場合は、プログラムを終了する）

  ```sql
  LEAVE ラベル
  ```

- `RETURN`文は、ストアドファンクションの実行を終了し、戻り値を返す。

  ```sql
  RETURN 値
  ```

### カーソル

- 記法

  | 記法                                       | 概要                                                         |
  | ------------------------------------------ | ------------------------------------------------------------ |
  | `DECLARE カーソル名 CURSOR FOR セレクト文` | カーソルを宣言し、セレクト文と関連付ける。                   |
  | `OPEN カーソル名`                          | カーソルを開く。                                             |
  | `CLOSE カーソル名`                         | カーソルを閉じる。                                           |
  | `FETCH カーソル名 INTO 変数名...`          | 開いているカーソルを次の行に進め、値を変数に代入する。<br />（変数の数は、セレクトするカラムの数と一致する必要がある） |
