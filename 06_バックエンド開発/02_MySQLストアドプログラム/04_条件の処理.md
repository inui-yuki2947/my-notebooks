# バックエンド開発/MySQLストアドプログラム/条件の処理

## 共通

### 概要

- [MySQL :: MySQL 5.6 リファレンスマニュアル :: 13.6.7 条件の処理](https://dev.mysql.com/doc/refman/5.6/ja/condition-handling.html)

### DECLARE ... CONDITION, HANDLER

- `DECLARE ... CONDITION`文は、名前付きエラー条件を宣言する。

  ```mysql
  DECLARE コンディション名 CONDITION FOR コンディション値
  ```

- `DECLARE ... HANDLER`文は、1つ以上の条件を処理するハンドラを指定する。

  ```mysql
  DECLARE ハンドラアクション HANDLER FOR コンディション値, コンディション値, ...
      ステートメント
  ```

- ハンドラアクション

| ハンドラアクション | 概要                                                         |
| ------------------ | ------------------------------------------------------------ |
| `CONTINUE`         | 現在のプログラムの実行が続行される。                         |
| `EXIT`             | このハンドラが宣言されている`BEGIN ... END`複合ステートメントの実行が終了する。 |

- コンディション値

| 記法                          | 概要                                                       | 例                 |
| ----------------------------- | ---------------------------------------------------------- | ------------------ |
| `MySQLエラーコード`           | 番号。<br />`0`から始まる場合は成功。                      | `1051`             |
| `SQLSTATE [VALUE] SQLSTATE値` | 5文字の文字列リテラル。                                    | `SQLSTATE '42S02'` |
| `コンディション名`            | `DECLARE ... CONDITION`文で定義した名前。                  |                    |
| `SQLWARNING`                  | `01` で始まるSQLSTATE値のクラスの短縮形。                  |                    |
| `NOT FOUND`                   | `02` で始まるSQLSTATE値のクラスの短縮形。                  |                    |
| `SQLEXCEPTION`                | `00`, `01` , `02` で始まらないSQLSTATE値のクラスの短縮形。 |                    |

- SQLSTATE値

  - `00`から始まる場合は成功。
  - `45000`は、未処理のユーザー定義の例外。

- 例（全ての`SQLEXCEPTION`で続行する）

  ```mysql
  DECLARE CONTINUE HANDLER
    FOR SQLWARNING
    BEGIN END
  ```

### 診断ステートメント

- 通常のステートメントは診断領域をクリアするが、診断ステートメントは診断領域をクリアしない。
- 診断ステートメント
  - `SHOW ERRORS`
  - `SHOW WARNINGS`
  - `GET DIAGNOSTICS`

### SHOW ERRORS, WARNINGS

- 記法

| 記法                     | 概要                                                         |
| ------------------------ | ------------------------------------------------------------ |
| `SHOW ERRORS`            | ステートメント実行結果の、エラー情報を表示する。             |
| `SHOW COUNT(*) ERRORS`   | ステートメント実行結果の、エラー情報**の数**を表示する。     |
| `SHOW WARNINGS`          | ステートメント実行結果の、エラー・警告・注意情報を表示する。 |
| `SHOW COUNT(*) WARNINGS` | ステートメント実行結果の、エラー・警告・注意情報**の数**を表示する。 |

### GET DIAGNOSTICS

- `GET DIAGNOSTICS`文は、診断情報を取得する。

- 記法1

  ```mysql
  GET [CURRENT,STACKED] DIAGNOSTICS
      変数 = ステートメント情報, 
      変数 = ステートメント情報,
      ...
  ```

- 記法2

  ```mysql
  GET [CURRENT,STACKED] DIAGNOSTICS CONDITION 条件番号
      変数 = 条件情報,
      変数 = 条件情報,
      ...
  ```

- 例

  ```mysql
  GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT
  ```

### SIGNAL, RESIGNAL

- `SIGNAL`文は、条件情報を渡す。

  ```mysql
  SIGNAL コンディション値
      [SET 条件情報 = 値, 条件情報 = 値, ...]
  ```

- `RESIGNAL`文は、条件情報を（変更してから）渡す。

  ```mysql
  RESIGNAL [コンディション値]
      [SET 条件情報 = 値, 条件情報 = 値, ...]
  ```

- `SET`句を含む場合は、エラーを変更して渡す。

- コンディション値を含む場合は、条件を現在の診断領域にプッシュする。

### 診断領域

- 診断領域には、下記の2種類の情報が含まれる。

  - ステートメント情報
  - 条件情報

- ステートメント情報

| ステートメント情報 | 概要                                         |
| ------------------ | -------------------------------------------- |
| `NUMBER`           | 情報が含まれている条件領域の数。             |
| `ROW_COUNT`        | このステートメントによって影響を受けた行数。 |

- 条件情報

| 条件情報            | 概要                          |
| ------------------- | ----------------------------- |
| `RETURNED_SQLSTATE` | この条件のSQLSTATE値。        |
| `MESSAGE_TEXT`      | この条件のエラーメッセージ。  |
| `MYSQL_ERRNO`       | この条件のMySQLエラーコード。 |
