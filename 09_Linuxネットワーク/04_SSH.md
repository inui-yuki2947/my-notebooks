# SSH

## 共通

### 概要

- SSHは、Telnetよりもセキュアにリモートホスト間通信を行うプロトコルである。
- SSHの実装である**OpenSSH**が一般的に利用されている。
- sshクライアントには、TeraTermやPuTTYなどがある。

### サーバ側設定

- `/etc/ssh/sshd_config`ファイルで、SSHサーバの設定を行う。

- 例

  ```text
  Port 10022
  PermitRootLogin no
  PasswordAuthentication no 
  ChallengeResponseAuthentication no
  PubkeyAuthentication yes
  ```

- 設定を反映するには、

  ```bash
  sudo systemctl restart sshd
  ```

### クライアント側設定

- 下記ファイルで、SSHクライアントの設定を行う。

  - `/etc/ssh/ssh_config`ファイル（システム全体）
  - `~/.ssh/config` ファイル（ユーザー固有）

- 書式

  ```text
  Host 接続名
    HostName ホスト名
    User ユーザー名
    Port ポート番号
    IdentityFile 公開鍵ファイル
  ```

- `IdentityFileの値`、`IdentityFileの値.pub`は、各コマンドでのデフォルトの秘密鍵・公開鍵ファイルとなる。
  （通常は、`~/.ssh/id_rsa`, `~/.ssh/id_rsa.pub`）

## 公開鍵認証

### ssh-keygen

- コマンド

  |コマンド|概要|
  |---|---|
  |`ssh-keygen`|公開鍵と秘密鍵のペアを作成する。|

- オプション

  |オプション|概要|
  |---|---|
  |`-f ファイル名`|ファイルを指定する。|
  |`-p`|パスフレーズを変更する。|
  |`-t 暗号化形式`|暗号化形式を指定できる。（デフォルトは`rsa`）|

- 秘密鍵のパーミッションは`600`にしておかないとエラーが出る。

### ~/.ssh/authorized_keys

- サーバー側の`~/.ssh/authorized_keys`には、公開鍵を記載する。

  ```text
  ssh-rsa 公開鍵1
  ssh-rsa 公開鍵2
  ...
  ```

- アクセス元を制限する場合

  ```text
  from=アクセス元 ssh-rsa 公開鍵
  ```

- 実行できるコマンドを制限する場合

  ```text
  command=コマンド ssh-rsa 公開鍵
  ```

- パーミッションは、`600`に設定しておくべき。

### ssh-copy-id

- コマンド

  |コマンド|概要|
  |---|---|
  |`ssh-copy-id [ユーザー名@]接続先`|簡単に公開鍵を接続先に登録する。|

- オプション

  |オプション|概要|
  |---|---|
  |`-i 公開鍵ファイル`|コピーする公開鍵ファイルを指定できる。|

### ssh-agent

- ssh-agentは、パスフレーズの入力を代わりに行う。

- ssh-agentの起動方法はいくつか存在する。
  [【SSH】ssh-agent の使い方 – ラボラジアン](https://laboradian.com/how-to-use-ssh-agent/)

  ```bash
  ssh-agent bash
  ```

- コマンド

  |コマンド|概要|
  |---|---|
  |`ssh-add 秘密鍵ファイル`|秘密鍵を登録する。|

## 接続

### ホスト認証

- SSHでは、ユーザー名とパスワードによる**ユーザー認証**に先立って、クライアントがサーバの正当性を確認する**ホスト認証**が行われる。
- 初回接続時に、ホストを信頼するかどうかを聞かれる。
- 信頼したホストは、`~/.ssh/known_hosts`ファイルに登録される。

### ssh

- コマンド

  | コマンド                                   | 概要                                                         |
  | ------------------------------------------ | ------------------------------------------------------------ |
  | `ssh [ユーザー名@]ホスト名 [コマンド]`     | SSH接続し、コマンドを実行する。<br />ユーザー名省略時は、ローカルと同名のユーザー名でログインする。 |
  | `ssh 接続名 [コマンド]`                    | 設定ファイルに記述した接続情報で接続し、コマンドを実行する。 |
  | `autossh [ユーザー名@]ホスト名 [コマンド]` | 自動で再接続を行うように`ssh`を実行する。                    |

- オプション

  | オプション          | 概要                               |
  | ------------------- | ---------------------------------- |
  | `-i 秘密鍵ファイル` | 使用する秘密鍵ファイルを指定する。 |
  | `-p ポート番号`     | ポート番号を指定する。             |

- オプション（ポートフォワード系）

  | オプション                                              | 概要                                                         |
  | ------------------------------------------------------- | ------------------------------------------------------------ |
  | `-L ローカルのポート:リモートのホスト:リモートのポート` | ローカルフォワードを行う。（入り口がローカル、出口がリモート） |
  | `-R リモートのポート:ローカルのホスト:ローカルのポート` | リモートフォワードを行う。（入り口がリモート、出口がローカル） |
  | `-g`                                                    | ローカル以外でもポートフォワードを行う。                     |
  | `-N`                                                    | シェルを開かないようにする。                                 |
  | `-f`                                                    | プロセスをバックグラウンドで実行する。                       |
  | `-A`                                                    | エージェント転送を行う。<br/>（1つ目のサーバに接続後、続けて別のサーバに接続する際に、最初に使った秘密鍵をそのまま使用する） |

  - 入り口・出口のホスト・ポートは、入り口・出口から見たホスト・ポートを指定する。
    （例：出口のホストが`localhost`の場合、それは出口のローカルホストである）

### X11転送

- **X11転送**は、ポート転送の仕組みを使って、リモートホストのXクライアントをローカルホストで動作させること。

- X11転送を有効にするには、`/etc/ssh/sshd_config`ファイルで以下のようにする。

  ```text
  X11Forwarding yes
  ```

- `ssh -X`コマンドで、X11転送を行える。
