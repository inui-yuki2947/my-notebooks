# シェル

## 設定

### 使用するシェル

- `/etc/shells`ファイルで、使用可能なシェル一覧を確認できる。
- 使用するシェルの設定
  - 環境変数`SHELL`（あまり信頼できない）
  - `/etc/passwd`ファイル
  - `chsh`コマンド

- コマンド

  |コマンド|概要|
  |---|---|
  |`chsh`|カレントユーザーのデフォルトのシェルを、対話的に変更する。|
  |`chsh ユーザー`|指定したユーザーのデフォルトのシェルを、対話的に変更する。|

- オプション

  | オプション        | 概要                                         |
  | ----------------- | -------------------------------------------- |
  | `-s シェルのパス` | 対話的でなく、デフォルトのシェルを変更する。 |

### 起動前後の設定

- ファイル

  ファイル|読み込みタイミング|用途
    ---|---|---
  `/etc/profile`|ログイン時|基本的な環境変数の設定
  `/etc/bashrc`（RedHat系）<br>`/etc/bash.bashrc`（Debian系）|対話的シェル起動時|
  `~/.bash_profile`<br>`~/.bash_login`<br>`~/.profile`|ログイン時|環境変数の設定
  `~/.bashrc`|対話的シェル起動時|エイリアスの設定、bashオプションの設定
  `~/.bash_logout`|ログアウト時|

- Linuxディストリビューションによって、読み込まれ方は異なる。
- `~/.bash_profile`から`~/.bash_rc`を読み込むよう記述することもある。

  ```bash
  [ -f ~/.bashrc ] && . ~/.bashrc
  ```
  
- [【初心者向け】エイリアスの設定方法 - Qiita](https://qiita.com/yutat93/items/b5bb9c0366f21bcbea62)
- [本当に正しい .bashrc と .bash_profile の使ひ分け - Qiita](https://qiita.com/magicant/items/d3bb7ea1192e63fba850)
- [bashの.profileや.bashrc等を実行する動作仕様 - sgryjp.log](https://blog.sgry.jp/entry/2019/11/09/232927)

### プロンプト

- 環境変数

  | 環境変数         | 概要                                          | デフォルト値 |
  | ---------------- | --------------------------------------------- | ------------ |
  | `PS1`            | プロンプト                                    | `\h:\W \u\$` |
  | `PS2`            | セカンダリプロンプト（2行目以降のプロンプト） |              |
  | `PROMPT_COMMAND` | プロンプトを出す前に実行するコマンド          |              |

- プロンプトで使える表現

  | 書式                                            | 概要                               | 例                           |
  | ----------------------------------------------- | ---------------------------------- | ---------------------------- |
  | `\D{フォーマット}`                              | 日時をフォーマット付きで指定する。 |                              |
  | `\[\e[フォントの数値;色の数値m\]文字列\[\e[m\]` | 文字列の色を変更する。             | `\[\e[1;33m\]文字列\[\e[m\]` |
  | `$(コマンド)`                                   | コマンドの結果を挿入する。         |                              |

- [ターミナルプロンプトの表示・色の変更 - Qiita](https://qiita.com/hmmrjn/items/60d2a64c9e5bf7c0fe60)

## シェルオプション

### 共通

- コマンド

  | コマンド | 概要                                           | 使用される環境変数 |
  | -------- | ---------------------------------------------- | ------------------ |
  | `set`    | `set`用のシェルオプションを管理する。          | `SHELLOPTS`        |
  | `shopt`  | `set`, `shopt`用のシェルオプションを管理する。 | `BASHOPTS`         |

### set

- コマンド

  | コマンド                                                     | 概要                                                         |
  | ------------------------------------------------------------ | ------------------------------------------------------------ |
  | `set -o`                                                     | 現在のシェルオプションの設定を表示する。                     |
  | `set +o`                                                     | 現在のシェルオプションの設定にするためのコマンドを表示する。 |
  | `set -ショートオプション`<br />`set -o ロングオプション` | シェルオプションを有効にする。                               |
  | `set +ショートオプション`<br />`set +o ロングオプション` | シェルオプションを無効にする。                               |
  | `bash -ショートオプション [ファイル名]`<br />`bash -o ロングオプション [ファイル名]` | シェルオプションを有効にしてスクリプトを実行する。           |
  | `bash +ショートオプション [ファイル名]`<br />`bash +o ロングオプション [ファイル名]` | シェルオプションを無効にしてスクリプトを実行する。           |

- シェルオプション

  | ショートオプション | ロングオプション | 概要                                                         |
  | ------------------ | ---------------- | ------------------------------------------------------------ |
  | `n`                | `noexec`         | コマンドを読み込むだけで実行しない。                         |
  | `e`                | `errexit`        | コマンドが1つでもエラーになったら、直ちにシェルを終了する。  |
  | `u`                | `nounset`        | パラメーター展開中に、設定していない変数があったらエラーとする。 |
  | `c`                | `noclobber`      | リダイレクトで既存のファイルを上書きしない。                 |
  | `x`                | `xtrace`         | 実際に実行されたコマンドを表示する。                         |
  | `v`                | `verbose`        | 書いたままのコマンドを表示する。                             |

- シェルオプション`x`とヌルコマンドを組み合わせて、デバッグメッセージを出力するテクニックがある。
  （当該コマンドで終了ステータスが変わることに注意）

  ```bash
  : デバッグ出力したい内容
  ```

### shopt

- コマンド

  | コマンド                      | 概要                                   |
  | ----------------------------- | -------------------------------------- |
  | `shopt`                      | シェルオプションの一覧を表示する。     |
  | `shopt シェルオプション名`    | 指定したシェルオプションを表示する。   |
  | `shopt -s`                    | 有効なシェルオプションのみ表示する。   |
  | `shopt -u`                    | 無効なシェルオプションのみ表示する。   |
  | `shopt -s シェルオプション名` | 指定したシェルオプションを有効にする。 |
  | `shopt -u シェルオプション名` | 指定したシェルオプションを無効にする。 |

- オプション

  | オプション | 概要                                            |
  | ---------- | ----------------------------------------------- |
  | `-o`       | `set`コマンドで使用するオプションについて扱う。 |

- シェルオプション

  | シェルオプション | 概要                                 |
  | ---------------- | ------------------------------------ |
  | `globstar`       | パス名展開で、`**`を使用可能にする。 |

## 操作

### ショートカット

- ショートカット

  | ショートカット | 概要                                                     |
  | -------------- | -------------------------------------------------------- |
  | `Ctrl + R`     | インクリメンタル検索を行う・選択肢を進める。             |
  | `Ctrl + S`     | インクリメンタル検索の選択肢を戻る。※1                   |
  | `Ctrl + C`     | 処理をキャンセルする。                                   |
  | `Ctrl + D`     | 入力の終わりを示す。入力中の文字が存在しなければ終了する |
  | `Ctrl + Z`     | 処理を一時中断する。                                     |
  | `Ctrl + S`     | スクリーンロックを行う。                                 |
  | `Ctrl + Q`     | スクリーンロックを解除する。                             |

- ※1 通常では`Ctrl + S`がスクリーンロックに割り当てられているので、以下のようにして解除する必要がある。

  ```bash
  stty stop undef
  ```

- [bashで覚えておきたいショートカットキー(キーバインド) | 俺的備忘録 〜なんかいろいろ〜](https://orebibou.com/ja/home/201506/20150629_001/)

### tmux

- コマンド

  | サブコマンド                   | 概要                                     |
  | ------------------------------ | ---------------------------------------- |
  | `tmux`<br />`tmux new-session` | 新しいセッションを開始する。             |
  | `tmux ls`                      | デタッチしたセッションの一覧を表示する。 |
  | `tmux attach`                  | 最新のセッションにアタッチする。         |
  | `tmux kill-session`            | 最新のセッションを削除する。             |
  | `tmux kill-server`             | 全てのセッションを削除する。             |

- オプション（`tmux attach, kill-session`）

  | オプション          | 概要                   |
    | ------------------- | ---------------------- |
  | `-t セッション番号` | セッションを指定する。 |

- 「Ctrl + B」をプリフィックスキーと呼ぶ。

- tmux内操作

  | 操作                                  | 概要                                 |
  | ------------------------------------- | ------------------------------------ |
  | プリフィックスキー + C                | 新しいウィンドウを作成する。         |
  | プリフィックスキー + ウィンドウの番号 | 任意の番号のウィンドウに切り替える。 |
  | プリフィックスキー + N/P              | 前後のウィンドウに切り替える。       |
  | プリフィックスキー + &                | ウィンドウを削除する。               |
  | プリフィックスキー + D                | デタッチする。                       |

## コマンド履歴

### コマンド履歴のフロー

1. Bash起動時に、`~/.bash_history`から読み込まれる。
1. Bash使用中は、キャッシュが使用される。
1. Bash終了時に、`~/.bash_history`に書き込まれる。

### 環境変数

- 環境変数

  | 環境変数         | 概要                                              | デフォルト値      |
  | ---------------- | ------------------------------------------------- | ----------------- |
  | `HISTFILE`       | コマンド履歴を記録するファイル。                  | `~/.bash_history` |
  | `HISTSIZE`       | シェルのコマンド履歴での保存数。                  |                   |
  | `HISTFILESIZE`   | コマンド履歴ファイルでの保存数。                  |                   |
  | `HISTCONTROL`    | コマンドの保存方法。（`:`で区切って複数指定可能） |                   |
  | `HISTTIMEFORMAT` | コマンド履歴の日時フォーマット。                  |                   |

- `HISTCONTROL`の値

  | `HISTCONTROL`の値 | 概要                                                   |
  | ----------------- | ------------------------------------------------------ |
  | `ignorespace`     | 空白で始まるコマンドを保存しない。                     |
  | `ignoredups`      | 直前の履歴と一致するコマンドを保存しない。             |
  | `ignoreboth`      | `ignoredups` + `ignorespace`                           |
  | `erasedups`       | 現在のコマンドと一致する履歴を保存前にすべて削除する。 |

- [history コマンドに日時を付与する - Qiita](https://qiita.com/bezeklik/items/56a597acc2eb568860d7)

### history

- コマンド

  |コマンド|概要|
  |---|---|
  |`history`|コマンド履歴を**全て**表示する。|
  |`history 件数`|コマンド履歴を**件数分**表示する。|

- オプション

  | オプション            | 概要                                                         |
  | --------------------- | ------------------------------------------------------------ |
  | `-r [ファイル名]`     | 履歴ファイルからキャッシュに、**全て追記**する。             |
  | `-n [ファイル名]`     | 履歴ファイルからキャッシュに、**読み込んでいないものを追記**する。 |
  | `-w [ファイル名]`     | キャッシュから履歴ファイルに、**上書き**する。               |
  | `-a [ファイル名]`     | キャッシュから履歴ファイルに、**書き込んでいないものを追記**する。 |
  | `-d コマンド履歴番号` | 指定したコマンド履歴を削除する。（`history -w`すると、ファイルに反映される） |
  | `-c`                  | 全コマンド履歴を削除する。（シェル終了時に、ファイルに反映される） |

### fc

- コマンド（実行系）

  | コマンド                       | 概要                                                         |
  | ------------------------------ | ------------------------------------------------------------ |
  | `fc [対象]`                    | 対象（省略時は直前）のコマンド履歴を編集し、実行する。       |
  | `fc 対象開始 対象終了`         | 対象開始から対象終了までのコマンド履歴を編集し、**全て**実行する。 |
  | `fc -s [置換前=置換後] [対象]` | 対象（省略時は直前）のコマンド履歴を置換し、実行する。       |

- コマンド（表示系）

  | コマンド                    | 概要                                               |
  | --------------------------- | -------------------------------------------------- |
  | `fc -l`                     | 直近16件のコマンド履歴を表示する。                 |
  | `fc -l 対象開始 [対象終了]` | 対象開始から対象終了までのコマンド履歴を表示する。 |
  | `fc -l -件数`               | 件数分のコマンド履歴を表示する。                   |

- 対象

  | 対象     | 概要                               |
  | -------- | ---------------------------------- |
  | `文字列` | 文字列から始まる直近のコマンド履歴 |
  | `番号`   | 該当番号のコマンド履歴             |
