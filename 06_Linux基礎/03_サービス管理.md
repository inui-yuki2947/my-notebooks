# サービス管理

## 共通

### 比較

| 名称     | 特徴                                         | プロセス            |
| -------- | -------------------------------------------- | ------------------- |
| SysVinit | あらかじめ決められた順にサービスが起動する。 | PIDによって管理     |
| Upstart  | プロセスを並列で起動する。                   |                     |
| systemd  | プロセスを並列で起動する。                   | cgroupsによって管理 |

## SysVinit

### 概要

- SysVinitでは、最初のinitプロセス（PID: 1）が、設定ファイルに基づいてサービスを起動していく。

### ファイル

- ファイル

  | ファイル                                  | 概要                                                   |
  | ----------------------------------------- | ------------------------------------------------------ |
  | `/etc/inittab`                            | 設定ファイル。デフォルトのランレベルが記載されている。 |
  | `/etc/init.d`ディレクトリ配下             | 起動スクリプトとして使われる。                         |
  | `/etc/rcランレベル.d`（例：`/etc/rc1.d`） | 各ランレベルで起動・終了するサービス。                 |

### ランレベル

- SysVinitでは、ランレベルごとに、どのようなサービスが稼働するかを決定する。
  
  | ランレベル | 概要                                                         |
  | ---------- | ------------------------------------------------------------ |
  | `0`        | 停止                                                         |
  | `1, s, S`  | シングルユーザーモード（rootユーザーだけが利用できる特殊な状態） |
  | `2, 3`     | マルチユーザーモード（テキストログイン）                     |
  | `5`        | マルチユーザーモード（グラフィカルログイン）                 |
  | `6`        | 再起動                                                       |

### runlevel, init, telinit

- コマンド

  |コマンド|概要|
  |---|---|
  |`runlevel`|現在のランレベルとその前のランレベルを表示する。|
  |`init ランレベル`<br />`telinit ランレベル`|ランレベルを変更する。|

## systemd

### 概要

- systemdを採用したシステムでは、initプロセスの代わりに、systemdプロセスが起動する。

### Unit

- systemdでは、システムの起動処理は、多数の**Unit**と呼ばれる処理単位に分かれている。

  | 拡張子     | 概要                                     |
  | ---------- | ---------------------------------------- |
  | `.service` | サービスを管理するUnit                   |
  | `.device`  | 各種デバイスを管理するUnit               |
  | `.mount`   | ファイルシステムのマウントを管理するUnit |
  | `.swap`    | スワップ領域を管理するUnit               |
  | `.target`  | 複数のサービスを一つにするUnit           |

### ファイル

- ファイル

  | ファイル                              | 概要                                       |
  | ------------------------------------- | ------------------------------------------ |
  | `/etc/systemd/system/default.target`  | 最初に実行されるUnit                       |
  | `/lib/systemd/system`ディレクトリ配下 | オリジナルのスクリプトファイル。           |
  | `/etc/systemd/system`ディレクトリ配下 | ホストごとに修正されたスクリプトファイル。 |

### systemctl

- コマンド

  |コマンド|概要|
  |---|---|
  |`systemctl サブコマンド [Unit名]`|systemdでサービスを管理できる。<br />Unit名の`.service`は省略できる。|

- サブコマンド
  
  | サブコマンド             | 概要                             |
  | ------------------------ | -------------------------------- |
  | `start`                  | サービスを起動する。             |
  | `stop`                   | サービスを終了する。             |
  | `restart`                | サービスを再起動する。           |
  | `enable`                 | サービスの自動起動を有効にする。 |
  | `disable`                | サービスの自動起動を無効にする。 |
  | `get-default`            | デフォルトのモードを表示する。   |
  | `set-default ターゲット` | デフォルトのモードを変更する。   |
  | `poweroff`               | システムをシャットダウンする。   |
  | `reboot`                 | システムを再起動する。           |

### service

- コマンド

  |コマンド|概要|
  |---|---|
  |`service Unit名 サブコマンド`|単にシェルを実行する形で、サービスの起動や停止、状態確認などを行う。|

- `service`より`systemctl`コマンドを使うことが望ましい。
  [Linuxのコマンド実行で使うserviceとsystemctlの違いとは何か？ | CodeLog](https://www.toumasu-program.net/qfr8l41pigu2v05ztwbc)

### launchctl

- Macでは、`launchctl`コマンドでサービスを管理できる。

  ```bash
  launchctl サブコマンド
  ```

## 電源管理

### ACPI

- ACPI（Advanced Configuration and Power Interface）は、コンピュータの電源を管理する規格である。

### shutdown

- コマンド

  |コマンド|概要|
  |---|---|
  |`shutdown 時間 [メッセージ]`|システムのシャットダウンや再起動ができる。（root権限が必要）|

- 時間

  | 時間    | 概要                     |
  | ------- | ------------------------ |
  | `now`   | 即実行を行う。           |
  | `+分`   | その分数後に実行を行う。 |
  | `hh:mm` | その時刻に実行を行う。   |

- オプション

  | オプション     | 概要                                                     |
  | -------------- | -------------------------------------------------------- |
  | `-k`           | 実際にシャットダウンせず、警告メッセージだけを表示する。 |
  | `-r, --reboot` | 再起動を行う。                                           |
  | `-c`           | 実行のキャンセルを行う。                                 |

- 当コマンド実行後は、ユーザーがログインできなくなる。

### wall

- コマンド

  | コマンド                                                     | 概要                                                         |
  | ------------------------------------------------------------ | ------------------------------------------------------------ |
  | `wall [メッセージ]`（GNU）<br />`wall [メッセージのあるファイル]`（BSD） | ログインしている全てのユーザーの端末に、一斉にメッセージを送信する。 |
