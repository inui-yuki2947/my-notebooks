# ログ管理

## 共通

### 概要

- システムのログを取得して処理するソフトウェアとしては、下記などがある。
  - syslog
  - rsyslog
  - syslog-ng

- ファイル

  | ファイル            | 概要                                                 |
  | ------------------- | ---------------------------------------------------- |
  | `/var/log/messages` | カーネルログなどが記録される、メインのログファイル。 |
  | `/var/log/secure`   | セキュリティに関するログが記録される。               |
  | `/var/log/maillog`  | メールに関するログが記録される。                     |

### 設定

- rsyslogの設定は下記で行う。

  - `/etc/rsyslog.conf`ファイル
  - `/etc/rsyslog.d`ディレクトリ以下のファイル

- 書式

  ```text
  ファシリティ.プライオリティ[;ファシリティ.プライオリティ...] アクション
  ```

- ファシリティは、メッセージの生成元を表す。

  | ファシリティ     | 概要           |
  | ---------------- | -------------- |
  | `auth, authpriv` | 認証サービス   |
  | `daemon`         | デーモン各種   |
  | `kern`           | カーネル       |
  | `lpr`            | 印刷サービス   |
  | `mail`           | メールサービス |

- プライオリティは、（表示を行う最低の）メッセージの重要度を表す。

  | プライオリティ | 概要                   |
  | -------------- | ---------------------- |
  | `*`            | 全てのプライオリティ   |
  | `none`         | 除外するプライオリティ |

- アクションは、出力先を表す。

  | アクション        | 概要                                         |
  | ----------------- | -------------------------------------------- |
  | `*`               | ログイン中の全てのユーザーの端末に出力する。 |
  | `ファイル名`      | ファイルに出力する。                         |
  | `@サーバアドレス` | 外部のsyslogサーバに出力する。               |

### dmesg

- コマンド

  |コマンド|概要|
  |---|---|
  |`dmesg`|システム起動時にカーネルがどのような処理を行ったか確認できる。|

### logger

- コマンド

  |コマンド|概要|
  |---|---|
  |`logger メッセージ`|ログメッセージを生成する。|

- オプション

  | オプション                       | 概要                                     |
  | -------------------------------- | ---------------------------------------- |
  | `-p ファシリティ.プライオリティ` | ファシリティ・プライオリティを指定する。 |
  | `-t タグ`                        | タグを指定する。                         |

### ローテーション

- ログのローテーション機能は、logrotateユーティリティが提供している。
- `/etc/logrotate.conf`ファイルで設定を行う。

## systemd-journald

### 概要

- systemdを採用したシステムでは、**systemd-journald**が、ログを**バイナリ形式**で記録する。

### /etc/systemd/journald.conf

- `/etc/systemd/journald.conf`ファイルで、sytemd-journaldの設定を行う。
- デフォルトでは、ログはメモリ上の`/run/log/journal`ディレクトリに出力されるが、
  設定により`/var/log/journal`ディレクトリに出力することもできる。

### journalctl

- コマンド

  |コマンド|概要|
  |---|---|
  |`journalctl [検索文字列]`|Unitのログを確認できる。|

- オプション

  | オプション              | 概要                                                  |
  | ----------------------- | ----------------------------------------------------- |
  | `-k, --dmesg`           | カーネルのログのみ出力する。（`dmesg`コマンドと同じ） |
  | `-b, --boot 番号`       | 特定のシステム起動時のログを出力する。                |
  | `-u, --unit ユニット名` | 指定したユニットのログを出力する。                    |
  | `-l, --full`            | 指定したユニットのログを出力する。                    |
  | `-n, --lines [行数]`    | 出力する行数を指定できる。（行数未指定時は10行）      |
  | `--since, --until 日時` | ログの日時を指定できる。                              |
  | `-o, --output 出力形式` | `verbose`や`json`などの出力形式が指定できる。         |

- 検索文字列

  |オプション|概要|
  |---|---|
  |`_SYSTEMD_UNIT=ユニット名`|指定したユニットのログを出力する。|

### systemd-cat

- コマンド

  |コマンド|概要|
  |---|---|
  |`systemd-cat コマンド`|systemdを採用したシステムで、コマンドの実行結果をジャーナルに書き込む。|
