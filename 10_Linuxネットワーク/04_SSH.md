# SSH

## 共通

### 概要

- SSHは、Telnetよりもセキュアにリモートホスト間通信を行うプロトコルである。
- SSHの実装である**OpenSSH**が一般的に利用されている。
- sshクライアントには、TeraTermやPuTTYなどがある。

### サーバ側設定

- `/etc/ssh/sshd_config`ファイルで、SSHサーバの設定を行う。

- 例

  ```text
  Port 10022
  PermitRootLogin no
  PasswordAuthentication no 
  ChallengeResponseAuthentication no
  PubkeyAuthentication yes
  ```

- 設定を反映するには、

  ```bash
  sudo systemctl restart sshd
  ```

### クライアント側設定

- `/etc/ssh/ssh_config`ファイルまたは`~/.ssh/config` ファイルで、SSHクライアントの設定を行う。

- 接続先のエイリアスを登録する場合

  ```text
  Host 接続名
    HostName ホスト名
    User ユーザー名
    Port ポート番号
    IdentityFile 公開鍵ファイル
  ```

- `IdentityFileの値`、`IdentityFileの値.pub`は、各コマンドでのデフォルトの秘密鍵・公開鍵ファイルとなる。
  （通常は、`~/.ssh/id_rsa`, `~/.ssh/id_rsa.pub`）

## 公開鍵認証

### ssh-keygen

- `ssh-keygen`コマンドは、公開鍵と秘密鍵のペアを作成する。

  ```bash
  ssh-keygen
  ```

- `-t 暗号化形式`オプションで、暗号化形式を指定できる。（デフォルトは`rsa`）

### ~/.ssh/authorized_keys

- サーバー側の`~/.ssh/authorized_keys`には、公開鍵を記載する。

  ```text
  ssh-rsa 公開鍵1
  ssh-rsa 公開鍵2
  ...
  ```

- アクセス元を制限する場合

  ```text
  from=アクセス元 ssh-rsa 公開鍵
  ```

- 実行できるコマンドを制限する場合

  ```text
  command=コマンド ssh-rsa 公開鍵
  ```

- パーミッションは、`600`に設定しておくべき。

### ssh-copy-id

- `ssh-copy-id`コマンドは、簡単に公開鍵を接続先に登録する。

  ```bash
  ssh-copy-id [ユーザー名@]接続先
  ```

- `-i 公開鍵ファイル`オプションで、コピーする公開鍵ファイルを指定できる。

### ssh-agent

- ssh-agentは、パスフレーズの入力を代わりに行う。

- ssh-agentの起動方法はいくつか存在する。
  [【SSH】ssh-agent の使い方 – ラボラジアン](https://laboradian.com/how-to-use-ssh-agent/)

  ```bash
  ssh-agent bash
  ```

- `ssh-add`コマンドは、秘密鍵を登録する。

  ```bash
   ssh-add 秘密鍵ファイル
  ```

## 接続

### ホスト認証

- SSHでは、ユーザー名とパスワードによる**ユーザー認証**に先立って、クライアントがサーバの正当性を確認する**ホスト認証**が行われる。
- 初回接続時に、ホストを信頼するかどうかを聞かれる。
- 信頼したホストは、`~/.ssh/known_hosts`ファイルに登録される。

### ssh

- 書式

  ```bash
  ssh [ユーザー名@]ホスト名　[コマンド]
  ```

- ユーザー名省略時は、ローカルと同名のユーザーでログインする。

- `-i 秘密鍵ファイル`オプションで、使用する秘密鍵ファイルを指定できる。

- `-p ポート番号`オプションで、ポート番号を指定できる。

### ポートフォワード

- `-L|-R`オプションで、ポートフォワードが行える。

  ```bash
  ssh -L|-R 入り口のポート:出口のホスト:出口のポート [ユーザー名@]踏み台ホスト名
  ```

- ローカルフォワードとリモートフォワード

  | オプション | 種類               | 概要                                       |
  | ---------- | ------------------ | ------------------------------------------ |
  | `-L`       | ローカルフォワード | 入り口がローカル、出口が踏み台に置かれる。 |
  | `-R`       | リモートフォワード | 入り口が踏み台、出口がローカルに置かれる。 |

- 入り口・出口のホスト・ポートは、入り口・出口から見たホスト・ポートを指定する。
  （例：出口のホストが`localhost`の場合、それは出口のローカルホストである）

- `-g`オプションで、ローカル以外でもポートフォワードを行うことができる。

- `-N`オプションで、シェルを開かないようにできる。

- `-f`オプションで、プロセスがバックグラウンドで実行される。

- `-A`オプションで、エージェント転送を行うことができる。
  （1つ目のサーバに接続後、続けて別のサーバに接続する際に、最初に使った秘密鍵をそのまま使用する）

### autossh

- `autossh`コマンドは、自動で再接続を行うように`ssh`を実行できる。

### X11転送

- **X11転送**は、ポート転送の仕組みを使って、リモートホストのXクライアントをローカルホストで動作させること。

- X11転送を有効にするには、`/etc/ssh/sshd_config`ファイルで以下のようにする。

  ```text
  X11Forwarding yes
  ```

- `ssh -X`コマンドで、X11転送を行える。

## SCP

### scp

- `scp`コマンドは、リモートでファイルをコピーする。

  ```bash
  scp コピー元 コピー先
  ```

- リモートのコピー元・コピー先は、`[ユーザー名@]ホスト名:ファイル名`の形式で指定する。
  （例：`user@example.com:~/test.txt`）

### rsync

- `rsync`コマンドは、賢い`scp`コマンド。
- `--update`オプションで、更新日時が新しいものを優先した上でコピーが行われる。
- `--times`オプションで、更新日時をコピー元と同じにすることができる。
- `--delete`オプションで、コピー先にしかないファイルを削除できる。
