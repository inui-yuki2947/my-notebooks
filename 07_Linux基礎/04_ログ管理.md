# ログ管理

## 共通

### 概要

- システムのログを取得して処理するソフトウェアとしては、下記などがある。
  - syslog
  - rsyslog
  - syslog-ng

### ログファイル

| ファイル            | 概要                                                 |
| ------------------- | ---------------------------------------------------- |
| `/var/log/messages` | カーネルログなどが記録される、メインのログファイル。 |
| `/var/log/secure`   | セキュリティに関するログが記録される。               |
| `/var/log/maillog`  | メールに関するログが記録される。                     |

### /etc/rsyslog.conf

- rsyslogの設定は、`/etc/rsyslog.conf`ファイル、及び`/etc/rsyslog.d`ディレクトリ以下のファイルで行う。

- 書式

  ```text
  ファシリティ.プライオリティ[;ファシリティ.プライオリティ...] アクション
  ```

- ファシリティは、メッセージの生成元を表す。

  - `auth`, `authpriv`は、認証サービス。
  - `daemon`は、デーモン各種。
  - `kern`は、カーネル。
  - `lpr`は、印刷サービス。
  - `mail`は、メールサービス。

- プライオリティは、（表示を行う最低の）メッセージの重要度を表す。

  - `*`を設定すると、全てのプライオリティとなる。
  - `none`を設定すると、ログを除外する。

- アクションは、出力先を表す。

  - `*`を指定すると、ログイン中の全てのユーザーの端末に出力する。
  - ファイル名を指定すると、ファイルに出力する。
  - `@サーバアドレス`を指定すると、外部のsyslogサーバに出力する。

### dmesg

- `dmesg`（display message）コマンドは、システム起動時にカーネルがどのような処理を行ったか確認できる。

  ```bash
  dmesg
  ```

### logger

- `logger`コマンドは、ログメッセージを生成する。

  ```bash
  logger メッセージ
  ```

- `-p ファシリティ.プライオリティ`オプションで、ファシリティ・プライオリティを指定できる。

- `-t タグ`オプションで、タグを指定できる。

### ローテーション

- ログのローテーション機能は、logrotateユーティリティが提供している。
- `/etc/logrotate.conf`ファイルで設定を行う。

## systemd-journald

### 概要

- systemdを採用したシステムでは、**systemd-journald**が、ログを**バイナリ形式**で記録する。

### /etc/systemd/journald.conf

- `/etc/systemd/journald.conf`ファイルで、sytemd-journaldの設定を行う。
- デフォルトでは、ログはメモリ上の`/run/log/journal`ディレクトリに出力されるが、
  設定により`/var/log/journal`ディレクトリに出力することもできる。

### journalctl

- `journalctl`コマンドで、Unitのログを確認できる。

  ```bash
  journalctl [検索文字列]
  ```

- オプション

  - `-k, --dmesg`オプションで、カーネルのログのみ出力する。（`dmesg`コマンドと同じ）
  - `-b, --boot 番号`オプションで、特定のシステム起動時のログを出力する。
  - `-u, --unit ユニット名`オプションで、指定したユニットのログを出力する。
  - `-l, --full`オプションで、全てのログを出力する。
  - `-n, --lines [行数（デフォルトは10）]`オプションで、出力する行数を指定できる。
  - `--since, --until 日時`オプションで、ログの日時を指定できる。
  - `-o, --output 出力形式`オプションで、`verbose`や`json`などの出力形式が指定できる。

- 検索文字列

  - `_SYSTEMD_UNIT=ユニット名`オプションで、指定したユニットのログを出力する。

### systemd-cat

- `systemd-cat`コマンドは、systemdを採用したシステムで、コマンドの実行結果をジャーナルに書き込む。

  ```bash
  systemd-cat コマンド
  ```
